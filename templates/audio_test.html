<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³é »æ’­æ”¾æ¸¬è©¦é é¢</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 20px;
            padding: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 10px;
        }
        .log-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .audio-player {
            width: 100%;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <h1 class="text-center mb-4">
            <i class="fas fa-volume-up"></i> ğŸ”Š éŸ³é »æ’­æ”¾æ¸¬è©¦é é¢
        </h1>
        
        <div class="alert alert-info">
            <h5><i class="fas fa-info-circle"></i> æ¸¬è©¦èªªæ˜</h5>
            <p>æ­¤é é¢ç”¨æ–¼æ¸¬è©¦éŸ³é »æ’­æ”¾åŠŸèƒ½ï¼Œå¹«åŠ©è¨ºæ–·èªéŸ³æ’­æ”¾å•é¡Œã€‚è«‹æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿé€²è¡Œæ¸¬è©¦ï¼š</p>
        </div>

        <!-- ç€è¦½å™¨éŸ³é »æ”¯æ´æ¸¬è©¦ -->
        <div class="test-section">
            <h4><i class="fas fa-check-circle"></i> 1. ç€è¦½å™¨éŸ³é »æ”¯æ´æ¸¬è©¦</h4>
            <div id="browserSupport" class="alert alert-secondary">
                æ­£åœ¨æª¢æ¸¬ç€è¦½å™¨éŸ³é »æ”¯æ´...
            </div>
            <button class="btn btn-primary" onclick="testBrowserAudioSupport()">
                <i class="fas fa-play"></i> æ¸¬è©¦ç€è¦½å™¨éŸ³é »æ”¯æ´
            </button>
        </div>

        <!-- æ¸¬è©¦éŸ³é »æ’­æ”¾ -->
        <div class="test-section">
            <h4><i class="fas fa-music"></i> 2. æ¸¬è©¦éŸ³é »æ’­æ”¾</h4>
            <div class="row">
                <div class="col-md-6">
                    <h6>å…§å»ºæ¸¬è©¦éŸ³é »</h6>
                    <audio id="testAudio" controls class="audio-player">
                        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT" type="audio/wav">
                        æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´éŸ³é »æ’­æ”¾
                    </audio>
                    <button class="btn btn-success btn-sm" onclick="playTestAudio()">
                        <i class="fas fa-play"></i> æ’­æ”¾æ¸¬è©¦éŸ³é »
                    </button>
                </div>
                <div class="col-md-6">
                    <h6>è‡ªå®šç¾©éŸ³é »æ¸¬è©¦</h6>
                    <input type="file" id="audioFileInput" accept="audio/*" class="form-control mb-2">
                    <button class="btn btn-info btn-sm" onclick="playCustomAudio()">
                        <i class="fas fa-play"></i> æ’­æ”¾è‡ªå®šç¾©éŸ³é »
                    </button>
                </div>
            </div>
        </div>

        <!-- èªéŸ³åˆæˆæ¸¬è©¦ -->
        <div class="test-section">
            <h4><i class="fas fa-microphone"></i> 3. èªéŸ³åˆæˆæ¸¬è©¦</h4>
            <div class="row">
                <div class="col-md-6">
                    <label for="testText" class="form-label">æ¸¬è©¦æ–‡å­—ï¼š</label>
                    <textarea id="testText" class="form-control" rows="3" placeholder="è¼¸å…¥è¦è½‰æ›ç‚ºèªéŸ³çš„æ¸¬è©¦æ–‡å­—">é€™æ˜¯ä¸€å€‹èªéŸ³åˆæˆæ¸¬è©¦ï¼Œç”¨æ–¼é©—è­‰éŸ³é »æ’­æ”¾åŠŸèƒ½æ˜¯å¦æ­£å¸¸ã€‚</textarea>
                </div>
                <div class="col-md-6">
                    <label for="voiceType" class="form-label">èªéŸ³é¡å‹ï¼š</label>
                    <select id="voiceType" class="form-control">
                        <option value="mandarin_female">åœ‹èªå¥³è²</option>
                        <option value="mandarin_male">åœ‹èªç”·è²</option>
                        <option value="english_female">è‹±æ–‡å¥³è²</option>
                        <option value="english_male">è‹±æ–‡ç”·è²</option>
                    </select>
                </div>
            </div>
            
            <!-- æ’­æ”¾é€Ÿåº¦æ§åˆ¶ -->
            <div class="row mt-2">
                <div class="col-md-6">
                    <label for="testPlaybackSpeed" class="form-label">
                        <i class="fas fa-tachometer-alt"></i> ğŸµ æ’­æ”¾é€Ÿåº¦ï¼š
                    </label>
                    <select id="testPlaybackSpeed" class="form-control">
                        <option value="0.5">0.5x (æ…¢é€Ÿ)</option>
                        <option value="0.75">0.75x (è¼ƒæ…¢)</option>
                        <option value="1.0">1.0x (æ­£å¸¸)</option>
                        <option value="1.25">1.25x (è¼ƒå¿«)</option>
                        <option value="1.5" selected>1.5x (å¿«é€Ÿ - é è¨­)</option>
                        <option value="2.0">2.0x (å€é€Ÿ)</option>
                    </select>
                    <small class="text-muted">é è¨­ç‚º1.5å€é€Ÿï¼ˆåŠ å¿«1/2ï¼‰</small>
                </div>
            </div>
            
            <div class="mt-3">
                <button class="btn btn-primary" onclick="testVoiceSynthesis()">
                    <i class="fas fa-microphone"></i> æ¸¬è©¦èªéŸ³åˆæˆ
                </button>
                <button class="btn btn-success" onclick="playSynthesizedVoice()" id="playSynthesizedBtn" disabled>
                    <i class="fas fa-play"></i> æ’­æ”¾åˆæˆèªéŸ³
                </button>
            </div>
        </div>

        <!-- éŸ³é »æ–‡ä»¶æª¢æŸ¥ -->
        <div class="test-section">
            <h4><i class="fas fa-file-audio"></i> 4. éŸ³é »æ–‡ä»¶æª¢æŸ¥</h4>
            <button class="btn btn-warning" onclick="checkAudioFiles()">
                <i class="fas fa-search"></i> æª¢æŸ¥éŸ³é »æ–‡ä»¶
            </button>
            <div id="audioFilesList" class="mt-3"></div>
        </div>

        <!-- æ—¥èªŒé¡¯ç¤º -->
        <div class="test-section">
            <h4><i class="fas fa-list"></i> 5. æ¸¬è©¦æ—¥èªŒ</h4>
            <button class="btn btn-secondary btn-sm" onclick="clearLog()">
                <i class="fas fa-trash"></i> æ¸…é™¤æ—¥èªŒ
            </button>
            <div id="logArea" class="log-area mt-2"></div>
        </div>

        <!-- å•é¡Œè¨ºæ–· -->
        <div class="test-section">
            <h4><i class="fas fa-stethoscope"></i> 6. å•é¡Œè¨ºæ–·</h4>
            <button class="btn btn-danger" onclick="runDiagnostics()">
                <i class="fas fa-search"></i> åŸ·è¡Œå®Œæ•´è¨ºæ–·
            </button>
            <div id="diagnosticsResult" class="mt-3"></div>
        </div>
    </div>

    <script>
        let synthesizedAudioPath = null;
        let testAudioElement = null;

        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            testBrowserAudioSupport();
            addLog('é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹éŸ³é »æ¸¬è©¦...');
        });

        // æ·»åŠ æ—¥èªŒ
        function addLog(message, type = 'info') {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        // æ¸…é™¤æ—¥èªŒ
        function clearLog() {
            document.getElementById('logArea').innerHTML = '';
            addLog('æ—¥èªŒå·²æ¸…é™¤');
        }

        // æ¸¬è©¦ç€è¦½å™¨éŸ³é »æ”¯æ´
        function testBrowserAudioSupport() {
            const supportDiv = document.getElementById('browserSupport');
            let supportInfo = '<h6>ç€è¦½å™¨éŸ³é »æ”¯æ´æª¢æ¸¬çµæœï¼š</h6>';
            
            // æª¢æŸ¥ Audio å°è±¡
            if (typeof Audio !== 'undefined') {
                supportInfo += '<p>âœ… Audio å°è±¡æ”¯æ´ï¼šæ˜¯</p>';
                addLog('Audio å°è±¡æ”¯æ´ï¼šæ˜¯');
            } else {
                supportInfo += '<p>âŒ Audio å°è±¡æ”¯æ´ï¼šå¦</p>';
                addLog('Audio å°è±¡æ”¯æ´ï¼šå¦', 'error');
            }

            // æª¢æŸ¥ Web Audio API
            if (typeof AudioContext !== 'undefined' || typeof webkitAudioContext !== 'undefined') {
                supportInfo += '<p>âœ… Web Audio API æ”¯æ´ï¼šæ˜¯</p>';
                addLog('Web Audio API æ”¯æ´ï¼šæ˜¯');
            } else {
                supportInfo += '<p>âŒ Web Audio API æ”¯æ´ï¼šå¦</p>';
                addLog('Web Audio API æ”¯æ´ï¼šå¦', 'warning');
            }

            // æª¢æŸ¥éŸ³é »æ ¼å¼æ”¯æ´
            const audio = new Audio();
            const formats = [
                { ext: 'mp3', mime: 'audio/mpeg' },
                { ext: 'wav', mime: 'audio/wav' },
                { ext: 'ogg', mime: 'audio/ogg' }
            ];

            formats.forEach(format => {
                if (audio.canPlayType(format.mime)) {
                    const support = audio.canPlayType(format.mime);
                    supportInfo += `<p>âœ… ${format.ext.toUpperCase()} æ ¼å¼æ”¯æ´ï¼š${support}</p>`;
                    addLog(`${format.ext.toUpperCase()} æ ¼å¼æ”¯æ´ï¼š${support}`);
                } else {
                    supportInfo += `<p>âŒ ${format.ext.toUpperCase()} æ ¼å¼æ”¯æ´ï¼šå¦</p>`;
                    addLog(`${format.ext.toUpperCase()} æ ¼å¼æ”¯æ´ï¼šå¦`, 'warning');
                }
            });

            // æª¢æŸ¥ç€è¦½å™¨ä¿¡æ¯
            supportInfo += `<p>ğŸŒ ç€è¦½å™¨ï¼š${navigator.userAgent}</p>`;
            supportInfo += `<p>ğŸ’» å¹³å°ï¼š${navigator.platform}</p>`;
            addLog(`ç€è¦½å™¨ï¼š${navigator.userAgent}`);
            addLog(`å¹³å°ï¼š${navigator.platform}`);

            supportDiv.innerHTML = supportInfo;
        }

        // æ’­æ”¾æ¸¬è©¦éŸ³é »
        function playTestAudio() {
            const audio = document.getElementById('testAudio');
            addLog('é–‹å§‹æ’­æ”¾å…§å»ºæ¸¬è©¦éŸ³é »');
            
            audio.play().then(() => {
                addLog('å…§å»ºæ¸¬è©¦éŸ³é »æ’­æ”¾æˆåŠŸ');
            }).catch(error => {
                addLog(`å…§å»ºæ¸¬è©¦éŸ³é »æ’­æ”¾å¤±æ•—ï¼š${error.message}`, 'error');
            });
        }

        // æ’­æ”¾è‡ªå®šç¾©éŸ³é »
        function playCustomAudio() {
            const fileInput = document.getElementById('audioFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                addLog('è«‹å…ˆé¸æ“‡éŸ³é »æ–‡ä»¶', 'warning');
                return;
            }

            addLog(`é¸æ“‡çš„éŸ³é »æ–‡ä»¶ï¼š${file.name} (${file.size} å­—ç¯€)`);
            
            const audio = new Audio();
            const url = URL.createObjectURL(file);
            
            audio.onloadstart = () => addLog('è‡ªå®šç¾©éŸ³é »é–‹å§‹è¼‰å…¥');
            audio.oncanplay = () => {
                addLog('è‡ªå®šç¾©éŸ³é »å¯ä»¥æ’­æ”¾');
                audio.play().then(() => {
                    addLog('è‡ªå®šç¾©éŸ³é »æ’­æ”¾æˆåŠŸ');
                }).catch(error => {
                    addLog(`è‡ªå®šç¾©éŸ³é »æ’­æ”¾å¤±æ•—ï¼š${error.message}`, 'error');
                });
            };
            audio.onerror = (e) => {
                addLog(`è‡ªå®šç¾©éŸ³é »è¼‰å…¥å¤±æ•—ï¼š${e}`, 'error');
            };
            
            audio.src = url;
        }

        // æ¸¬è©¦èªéŸ³åˆæˆ
        function testVoiceSynthesis() {
            const testText = document.getElementById('testText').value;
            const voiceType = document.getElementById('voiceType').value;
            
            if (!testText.trim()) {
                addLog('è«‹è¼¸å…¥æ¸¬è©¦æ–‡å­—', 'warning');
                return;
            }

            addLog(`é–‹å§‹æ¸¬è©¦èªéŸ³åˆæˆï¼Œæ–‡å­—ï¼š${testText.substring(0, 50)}...`);
            addLog(`èªéŸ³é¡å‹ï¼š${voiceType}`);

            // ç™¼é€èªéŸ³åˆæˆè«‹æ±‚
            fetch('/api/voice/summary', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    summary_text: testText,
                    voice_type: voiceType
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLog('èªéŸ³åˆæˆæˆåŠŸ');
                    addLog(`èªéŸ³å…§å®¹ï¼š${data.voice_content}`);
                    addLog(`éŸ³é »æ–‡ä»¶è·¯å¾‘ï¼š${data.audio_file_path}`);
                    
                    synthesizedAudioPath = data.audio_file_path;
                    document.getElementById('playSynthesizedBtn').disabled = false;
                    
                    addLog('å¯ä»¥é»æ“Šæ’­æ”¾æŒ‰éˆ•æ¸¬è©¦éŸ³é »æ’­æ”¾');
                } else {
                    addLog(`èªéŸ³åˆæˆå¤±æ•—ï¼š${data.error}`, 'error');
                }
            })
            .catch(error => {
                addLog(`èªéŸ³åˆæˆè«‹æ±‚å¤±æ•—ï¼š${error.message}`, 'error');
            });
        }

        // æ’­æ”¾åˆæˆèªéŸ³
        function playSynthesizedVoice() {
            if (!synthesizedAudioPath) {
                addLog('æ²’æœ‰å¯æ’­æ”¾çš„åˆæˆèªéŸ³', 'warning');
                return;
            }

            addLog('é–‹å§‹æ’­æ”¾åˆæˆèªéŸ³');
            
            // å¾éŸ³é »æ–‡ä»¶è·¯å¾‘ä¸­æå–æ–‡ä»¶å
            const audioFileName = synthesizedAudioPath.split('/').pop();
            const audioUrl = `/api/voice/audio/${audioFileName}`;
            
            addLog(`éŸ³é »URLï¼š${audioUrl}`);
            
            // å‰µå»ºéŸ³é »å…ƒç´ 
            const audio = new Audio();
            
            // è¨­ç½®éŸ³é »äº‹ä»¶
            audio.onloadstart = () => addLog('åˆæˆèªéŸ³é–‹å§‹è¼‰å…¥');
            audio.oncanplay = () => {
                addLog('åˆæˆèªéŸ³å¯ä»¥æ’­æ”¾');
                audio.play().then(() => {
                    addLog('åˆæˆèªéŸ³æ’­æ”¾æˆåŠŸ');
                }).catch(error => {
                    addLog(`åˆæˆèªéŸ³æ’­æ”¾å¤±æ•—ï¼š${error.message}`, 'error');
                });
            };
            audio.onended = () => addLog('åˆæˆèªéŸ³æ’­æ”¾çµæŸ');
            audio.onerror = (e) => {
                addLog(`åˆæˆèªéŸ³è¼‰å…¥å¤±æ•—ï¼š${e}`, 'error');
                addLog(`éŸ³é »éŒ¯èª¤è©³æƒ…ï¼š${audio.error ? audio.error.message : 'æœªçŸ¥éŒ¯èª¤'}`);
            };
            
            // è¨­ç½®éŸ³é »å±¬æ€§
            audio.volume = 1.0;
            audio.preload = 'auto';
            
            // è¨­ç½®æ’­æ”¾é€Ÿåº¦
            const speedSelect = document.getElementById('testPlaybackSpeed');
            const selectedSpeed = parseFloat(speedSelect.value);
            audio.playbackRate = selectedSpeed;
            addLog(`æ’­æ”¾é€Ÿåº¦è¨­ç½®ç‚º: ${selectedSpeed}x`);
            
            audio.src = audioUrl;
        }

        // æª¢æŸ¥éŸ³é »æ–‡ä»¶
        function checkAudioFiles() {
            addLog('é–‹å§‹æª¢æŸ¥éŸ³é »æ–‡ä»¶');
            
            // é€™è£¡å¯ä»¥æ·»åŠ æª¢æŸ¥é‚è¼¯ï¼Œæ¯”å¦‚æª¢æŸ¥è‡¨æ™‚ç›®éŒ„ä¸­çš„éŸ³é »æ–‡ä»¶
            addLog('éŸ³é »æ–‡ä»¶æª¢æŸ¥åŠŸèƒ½å¾…å¯¦ç¾');
        }

        // åŸ·è¡Œå®Œæ•´è¨ºæ–·
        function runDiagnostics() {
            const resultDiv = document.getElementById('diagnosticsResult');
            let diagnostics = '<h6>å®Œæ•´è¨ºæ–·çµæœï¼š</h6>';
            
            addLog('é–‹å§‹åŸ·è¡Œå®Œæ•´è¨ºæ–·');
            
            // æª¢æŸ¥ç€è¦½å™¨æ”¯æ´
            if (typeof Audio !== 'undefined') {
                diagnostics += '<p>âœ… ç€è¦½å™¨éŸ³é »æ”¯æ´ï¼šæ­£å¸¸</p>';
                addLog('ç€è¦½å™¨éŸ³é »æ”¯æ´ï¼šæ­£å¸¸');
            } else {
                diagnostics += '<p>âŒ ç€è¦½å™¨éŸ³é »æ”¯æ´ï¼šç•°å¸¸</p>';
                addLog('ç€è¦½å™¨éŸ³é »æ”¯æ´ï¼šç•°å¸¸', 'error');
            }

            // æª¢æŸ¥ç¶²è·¯é€£ç·š
            if (navigator.onLine) {
                diagnostics += '<p>âœ… ç¶²è·¯é€£ç·šï¼šæ­£å¸¸</p>';
                addLog('ç¶²è·¯é€£ç·šï¼šæ­£å¸¸');
            } else {
                diagnostics += '<p>âŒ ç¶²è·¯é€£ç·šï¼šé›¢ç·š</p>';
                addLog('ç¶²è·¯é€£ç·šï¼šé›¢ç·š', 'warning');
            }

            // æª¢æŸ¥éŸ³é »ä¸Šä¸‹æ–‡
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                diagnostics += '<p>âœ… éŸ³é »ä¸Šä¸‹æ–‡ï¼šæ­£å¸¸</p>';
                addLog('éŸ³é »ä¸Šä¸‹æ–‡ï¼šæ­£å¸¸');
                audioContext.close();
            } catch (error) {
                diagnostics += '<p>âŒ éŸ³é »ä¸Šä¸‹æ–‡ï¼šç•°å¸¸</p>';
                addLog(`éŸ³é »ä¸Šä¸‹æ–‡ç•°å¸¸ï¼š${error.message}`, 'error');
            }

            // æª¢æŸ¥éŸ³é »æ’­æ”¾æ¬Šé™
            navigator.permissions.query({ name: 'microphone' }).then(result => {
                if (result.state === 'granted') {
                    diagnostics += '<p>âœ… éŸ³é »æ¬Šé™ï¼šå·²æˆäºˆ</p>';
                    addLog('éŸ³é »æ¬Šé™ï¼šå·²æˆäºˆ');
                } else {
                    diagnostics += '<p>âš ï¸ éŸ³é »æ¬Šé™ï¼šæœªæˆäºˆ</p>';
                    addLog('éŸ³é »æ¬Šé™ï¼šæœªæˆäºˆ', 'warning');
                }
            }).catch(error => {
                diagnostics += '<p>âŒ éŸ³é »æ¬Šé™æª¢æŸ¥ï¼šå¤±æ•—</p>';
                addLog(`éŸ³é »æ¬Šé™æª¢æŸ¥å¤±æ•—ï¼š${error.message}`, 'error');
            });

            // æª¢æŸ¥éŸ³é »å…ƒç´ 
            const testAudio = document.getElementById('testAudio');
            if (testAudio.readyState >= 2) {
                diagnostics += '<p>âœ… éŸ³é »å…ƒç´ ï¼šæ­£å¸¸</p>';
                addLog('éŸ³é »å…ƒç´ ï¼šæ­£å¸¸');
            } else {
                diagnostics += '<p>âŒ éŸ³é »å…ƒç´ ï¼šç•°å¸¸</p>';
                addLog('éŸ³é »å…ƒç´ ï¼šç•°å¸¸', 'error');
            }

            resultDiv.innerHTML = diagnostics;
            addLog('å®Œæ•´è¨ºæ–·å®Œæˆ');
        }
    </script>
</body>
</html>
