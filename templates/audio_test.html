<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音頻播放測試頁面</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 20px;
            padding: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 10px;
        }
        .log-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .audio-player {
            width: 100%;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <h1 class="text-center mb-4">
            <i class="fas fa-volume-up"></i> 🔊 音頻播放測試頁面
        </h1>
        
        <div class="alert alert-info">
            <h5><i class="fas fa-info-circle"></i> 測試說明</h5>
            <p>此頁面用於測試音頻播放功能，幫助診斷語音播放問題。請按照以下步驟進行測試：</p>
        </div>

        <!-- 瀏覽器音頻支援測試 -->
        <div class="test-section">
            <h4><i class="fas fa-check-circle"></i> 1. 瀏覽器音頻支援測試</h4>
            <div id="browserSupport" class="alert alert-secondary">
                正在檢測瀏覽器音頻支援...
            </div>
            <button class="btn btn-primary" onclick="testBrowserAudioSupport()">
                <i class="fas fa-play"></i> 測試瀏覽器音頻支援
            </button>
        </div>

        <!-- 測試音頻播放 -->
        <div class="test-section">
            <h4><i class="fas fa-music"></i> 2. 測試音頻播放</h4>
            <div class="row">
                <div class="col-md-6">
                    <h6>內建測試音頻</h6>
                    <audio id="testAudio" controls class="audio-player">
                        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT" type="audio/wav">
                        您的瀏覽器不支援音頻播放
                    </audio>
                    <button class="btn btn-success btn-sm" onclick="playTestAudio()">
                        <i class="fas fa-play"></i> 播放測試音頻
                    </button>
                </div>
                <div class="col-md-6">
                    <h6>自定義音頻測試</h6>
                    <input type="file" id="audioFileInput" accept="audio/*" class="form-control mb-2">
                    <button class="btn btn-info btn-sm" onclick="playCustomAudio()">
                        <i class="fas fa-play"></i> 播放自定義音頻
                    </button>
                </div>
            </div>
        </div>

        <!-- 語音合成測試 -->
        <div class="test-section">
            <h4><i class="fas fa-microphone"></i> 3. 語音合成測試</h4>
            <div class="row">
                <div class="col-md-6">
                    <label for="testText" class="form-label">測試文字：</label>
                    <textarea id="testText" class="form-control" rows="3" placeholder="輸入要轉換為語音的測試文字">這是一個語音合成測試，用於驗證音頻播放功能是否正常。</textarea>
                </div>
                <div class="col-md-6">
                    <label for="voiceType" class="form-label">語音類型：</label>
                    <select id="voiceType" class="form-control">
                        <option value="mandarin_female">國語女聲</option>
                        <option value="mandarin_male">國語男聲</option>
                        <option value="english_female">英文女聲</option>
                        <option value="english_male">英文男聲</option>
                    </select>
                </div>
            </div>
            
            <!-- 播放速度控制 -->
            <div class="row mt-2">
                <div class="col-md-6">
                    <label for="testPlaybackSpeed" class="form-label">
                        <i class="fas fa-tachometer-alt"></i> 🎵 播放速度：
                    </label>
                    <select id="testPlaybackSpeed" class="form-control">
                        <option value="0.5">0.5x (慢速)</option>
                        <option value="0.75">0.75x (較慢)</option>
                        <option value="1.0">1.0x (正常)</option>
                        <option value="1.25">1.25x (較快)</option>
                        <option value="1.5" selected>1.5x (快速 - 預設)</option>
                        <option value="2.0">2.0x (倍速)</option>
                    </select>
                    <small class="text-muted">預設為1.5倍速（加快1/2）</small>
                </div>
            </div>
            
            <div class="mt-3">
                <button class="btn btn-primary" onclick="testVoiceSynthesis()">
                    <i class="fas fa-microphone"></i> 測試語音合成
                </button>
                <button class="btn btn-success" onclick="playSynthesizedVoice()" id="playSynthesizedBtn" disabled>
                    <i class="fas fa-play"></i> 播放合成語音
                </button>
            </div>
        </div>

        <!-- 音頻文件檢查 -->
        <div class="test-section">
            <h4><i class="fas fa-file-audio"></i> 4. 音頻文件檢查</h4>
            <button class="btn btn-warning" onclick="checkAudioFiles()">
                <i class="fas fa-search"></i> 檢查音頻文件
            </button>
            <div id="audioFilesList" class="mt-3"></div>
        </div>

        <!-- 日誌顯示 -->
        <div class="test-section">
            <h4><i class="fas fa-list"></i> 5. 測試日誌</h4>
            <button class="btn btn-secondary btn-sm" onclick="clearLog()">
                <i class="fas fa-trash"></i> 清除日誌
            </button>
            <div id="logArea" class="log-area mt-2"></div>
        </div>

        <!-- 問題診斷 -->
        <div class="test-section">
            <h4><i class="fas fa-stethoscope"></i> 6. 問題診斷</h4>
            <button class="btn btn-danger" onclick="runDiagnostics()">
                <i class="fas fa-search"></i> 執行完整診斷
            </button>
            <div id="diagnosticsResult" class="mt-3"></div>
        </div>
    </div>

    <script>
        let synthesizedAudioPath = null;
        let testAudioElement = null;

        // 頁面載入時執行
        document.addEventListener('DOMContentLoaded', function() {
            testBrowserAudioSupport();
            addLog('頁面載入完成，開始音頻測試...');
        });

        // 添加日誌
        function addLog(message, type = 'info') {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        // 清除日誌
        function clearLog() {
            document.getElementById('logArea').innerHTML = '';
            addLog('日誌已清除');
        }

        // 測試瀏覽器音頻支援
        function testBrowserAudioSupport() {
            const supportDiv = document.getElementById('browserSupport');
            let supportInfo = '<h6>瀏覽器音頻支援檢測結果：</h6>';
            
            // 檢查 Audio 對象
            if (typeof Audio !== 'undefined') {
                supportInfo += '<p>✅ Audio 對象支援：是</p>';
                addLog('Audio 對象支援：是');
            } else {
                supportInfo += '<p>❌ Audio 對象支援：否</p>';
                addLog('Audio 對象支援：否', 'error');
            }

            // 檢查 Web Audio API
            if (typeof AudioContext !== 'undefined' || typeof webkitAudioContext !== 'undefined') {
                supportInfo += '<p>✅ Web Audio API 支援：是</p>';
                addLog('Web Audio API 支援：是');
            } else {
                supportInfo += '<p>❌ Web Audio API 支援：否</p>';
                addLog('Web Audio API 支援：否', 'warning');
            }

            // 檢查音頻格式支援
            const audio = new Audio();
            const formats = [
                { ext: 'mp3', mime: 'audio/mpeg' },
                { ext: 'wav', mime: 'audio/wav' },
                { ext: 'ogg', mime: 'audio/ogg' }
            ];

            formats.forEach(format => {
                if (audio.canPlayType(format.mime)) {
                    const support = audio.canPlayType(format.mime);
                    supportInfo += `<p>✅ ${format.ext.toUpperCase()} 格式支援：${support}</p>`;
                    addLog(`${format.ext.toUpperCase()} 格式支援：${support}`);
                } else {
                    supportInfo += `<p>❌ ${format.ext.toUpperCase()} 格式支援：否</p>`;
                    addLog(`${format.ext.toUpperCase()} 格式支援：否`, 'warning');
                }
            });

            // 檢查瀏覽器信息
            supportInfo += `<p>🌐 瀏覽器：${navigator.userAgent}</p>`;
            supportInfo += `<p>💻 平台：${navigator.platform}</p>`;
            addLog(`瀏覽器：${navigator.userAgent}`);
            addLog(`平台：${navigator.platform}`);

            supportDiv.innerHTML = supportInfo;
        }

        // 播放測試音頻
        function playTestAudio() {
            const audio = document.getElementById('testAudio');
            addLog('開始播放內建測試音頻');
            
            audio.play().then(() => {
                addLog('內建測試音頻播放成功');
            }).catch(error => {
                addLog(`內建測試音頻播放失敗：${error.message}`, 'error');
            });
        }

        // 播放自定義音頻
        function playCustomAudio() {
            const fileInput = document.getElementById('audioFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                addLog('請先選擇音頻文件', 'warning');
                return;
            }

            addLog(`選擇的音頻文件：${file.name} (${file.size} 字節)`);
            
            const audio = new Audio();
            const url = URL.createObjectURL(file);
            
            audio.onloadstart = () => addLog('自定義音頻開始載入');
            audio.oncanplay = () => {
                addLog('自定義音頻可以播放');
                audio.play().then(() => {
                    addLog('自定義音頻播放成功');
                }).catch(error => {
                    addLog(`自定義音頻播放失敗：${error.message}`, 'error');
                });
            };
            audio.onerror = (e) => {
                addLog(`自定義音頻載入失敗：${e}`, 'error');
            };
            
            audio.src = url;
        }

        // 測試語音合成
        function testVoiceSynthesis() {
            const testText = document.getElementById('testText').value;
            const voiceType = document.getElementById('voiceType').value;
            
            if (!testText.trim()) {
                addLog('請輸入測試文字', 'warning');
                return;
            }

            addLog(`開始測試語音合成，文字：${testText.substring(0, 50)}...`);
            addLog(`語音類型：${voiceType}`);

            // 發送語音合成請求
            fetch('/api/voice/summary', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    summary_text: testText,
                    voice_type: voiceType
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLog('語音合成成功');
                    addLog(`語音內容：${data.voice_content}`);
                    addLog(`音頻文件路徑：${data.audio_file_path}`);
                    
                    synthesizedAudioPath = data.audio_file_path;
                    document.getElementById('playSynthesizedBtn').disabled = false;
                    
                    addLog('可以點擊播放按鈕測試音頻播放');
                } else {
                    addLog(`語音合成失敗：${data.error}`, 'error');
                }
            })
            .catch(error => {
                addLog(`語音合成請求失敗：${error.message}`, 'error');
            });
        }

        // 播放合成語音
        function playSynthesizedVoice() {
            if (!synthesizedAudioPath) {
                addLog('沒有可播放的合成語音', 'warning');
                return;
            }

            addLog('開始播放合成語音');
            
            // 從音頻文件路徑中提取文件名
            const audioFileName = synthesizedAudioPath.split('/').pop();
            const audioUrl = `/api/voice/audio/${audioFileName}`;
            
            addLog(`音頻URL：${audioUrl}`);
            
            // 創建音頻元素
            const audio = new Audio();
            
            // 設置音頻事件
            audio.onloadstart = () => addLog('合成語音開始載入');
            audio.oncanplay = () => {
                addLog('合成語音可以播放');
                audio.play().then(() => {
                    addLog('合成語音播放成功');
                }).catch(error => {
                    addLog(`合成語音播放失敗：${error.message}`, 'error');
                });
            };
            audio.onended = () => addLog('合成語音播放結束');
            audio.onerror = (e) => {
                addLog(`合成語音載入失敗：${e}`, 'error');
                addLog(`音頻錯誤詳情：${audio.error ? audio.error.message : '未知錯誤'}`);
            };
            
            // 設置音頻屬性
            audio.volume = 1.0;
            audio.preload = 'auto';
            
            // 設置播放速度
            const speedSelect = document.getElementById('testPlaybackSpeed');
            const selectedSpeed = parseFloat(speedSelect.value);
            audio.playbackRate = selectedSpeed;
            addLog(`播放速度設置為: ${selectedSpeed}x`);
            
            audio.src = audioUrl;
        }

        // 檢查音頻文件
        function checkAudioFiles() {
            addLog('開始檢查音頻文件');
            
            // 這裡可以添加檢查邏輯，比如檢查臨時目錄中的音頻文件
            addLog('音頻文件檢查功能待實現');
        }

        // 執行完整診斷
        function runDiagnostics() {
            const resultDiv = document.getElementById('diagnosticsResult');
            let diagnostics = '<h6>完整診斷結果：</h6>';
            
            addLog('開始執行完整診斷');
            
            // 檢查瀏覽器支援
            if (typeof Audio !== 'undefined') {
                diagnostics += '<p>✅ 瀏覽器音頻支援：正常</p>';
                addLog('瀏覽器音頻支援：正常');
            } else {
                diagnostics += '<p>❌ 瀏覽器音頻支援：異常</p>';
                addLog('瀏覽器音頻支援：異常', 'error');
            }

            // 檢查網路連線
            if (navigator.onLine) {
                diagnostics += '<p>✅ 網路連線：正常</p>';
                addLog('網路連線：正常');
            } else {
                diagnostics += '<p>❌ 網路連線：離線</p>';
                addLog('網路連線：離線', 'warning');
            }

            // 檢查音頻上下文
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                diagnostics += '<p>✅ 音頻上下文：正常</p>';
                addLog('音頻上下文：正常');
                audioContext.close();
            } catch (error) {
                diagnostics += '<p>❌ 音頻上下文：異常</p>';
                addLog(`音頻上下文異常：${error.message}`, 'error');
            }

            // 檢查音頻播放權限
            navigator.permissions.query({ name: 'microphone' }).then(result => {
                if (result.state === 'granted') {
                    diagnostics += '<p>✅ 音頻權限：已授予</p>';
                    addLog('音頻權限：已授予');
                } else {
                    diagnostics += '<p>⚠️ 音頻權限：未授予</p>';
                    addLog('音頻權限：未授予', 'warning');
                }
            }).catch(error => {
                diagnostics += '<p>❌ 音頻權限檢查：失敗</p>';
                addLog(`音頻權限檢查失敗：${error.message}`, 'error');
            });

            // 檢查音頻元素
            const testAudio = document.getElementById('testAudio');
            if (testAudio.readyState >= 2) {
                diagnostics += '<p>✅ 音頻元素：正常</p>';
                addLog('音頻元素：正常');
            } else {
                diagnostics += '<p>❌ 音頻元素：異常</p>';
                addLog('音頻元素：異常', 'error');
            }

            resultDiv.innerHTML = diagnostics;
            addLog('完整診斷完成');
        }
    </script>
</body>
</html>
