<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµ±ä¸€é æ¸¬å•é¡Œè¨ºæ–·å·¥å…·</title>
    
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { margin: 5px; padding: 10px 15px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .log { max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>ğŸ” çµ±ä¸€é æ¸¬å•é¡Œè¨ºæ–·å·¥å…·</h1>
    
    <div class="section info">
        <h3>ğŸ“‹ è¨ºæ–·èªªæ˜</h3>
        <p>æ­¤å·¥å…·ç”¨æ–¼è¨ºæ–·çµ±ä¸€é æ¸¬åœ–è¡¨é é¢é¡¯ç¤ºç©ºç™½çš„å•é¡Œã€‚è«‹æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿé€²è¡Œè¨ºæ–·ï¼š</p>
        <ol>
            <li>é»æ“Šã€Œé–‹å§‹è¨ºæ–·ã€æŒ‰éˆ•</li>
            <li>æŸ¥çœ‹å„é …æª¢æŸ¥çµæœ</li>
            <li>å¦‚æœç™¼ç¾å•é¡Œï¼Œè«‹è¨˜éŒ„éŒ¯èª¤è¨Šæ¯</li>
            <li>æ ¹æ“šè¨ºæ–·çµæœé€²è¡Œç›¸æ‡‰ä¿®å¾©</li>
        </ol>
    </div>
    
    <div class="section">
        <h3>ğŸ¯ è¨ºæ–·æ§åˆ¶</h3>
        <button onclick="startDiagnosis()">é–‹å§‹è¨ºæ–·</button>
        <button onclick="clearResults()">æ¸…é™¤çµæœ</button>
        <button onclick="testChartJS()">æ¸¬è©¦ Chart.js</button>
        <button onclick="testAPI()">æ¸¬è©¦ API</button>
        <button onclick="checkConsole()">æª¢æŸ¥æ§åˆ¶å°</button>
    </div>
    
    <div id="results"></div>
    
    <div class="section">
        <h3>ğŸ“Š è¨ºæ–·æ—¥èªŒ</h3>
        <div id="log" class="log"></div>
    </div>
    
    <script>
        let logCount = 0;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('log');
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            logEntry.className = type;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            logCount++;
        }
        
        function addResult(title, content, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `section ${type}`;
            resultDiv.innerHTML = `
                <h4>${title}</h4>
                <div>${content}</div>
            `;
            resultsDiv.appendChild(resultDiv);
        }
        
        async function startDiagnosis() {
            log('é–‹å§‹åŸ·è¡Œå®Œæ•´è¨ºæ–·...', 'info');
            
            // æ¸…é™¤ä¹‹å‰çµæœ
            clearResults();
            
            // 1. æª¢æŸ¥åŸºæœ¬ç’°å¢ƒ
            await checkBasicEnvironment();
            
            // 2. æª¢æŸ¥å¤–éƒ¨è³‡æº
            await checkExternalResources();
            
            // 3. æª¢æŸ¥ API ç«¯é»
            await checkAPIEndpoints();
            
            // 4. æª¢æŸ¥é é¢åŠŸèƒ½
            checkPageFunctionality();
            
            log('è¨ºæ–·å®Œæˆï¼', 'success');
        }
        
        async function checkBasicEnvironment() {
            log('æª¢æŸ¥åŸºæœ¬ç’°å¢ƒ...', 'info');
            
            const checks = [
                { name: 'JavaScript åŸ·è¡Œ', test: () => typeof window !== 'undefined' },
                { name: 'DOM æ”¯æ´', test: () => typeof document !== 'undefined' },
                { name: 'Fetch API', test: () => typeof fetch !== 'undefined' },
                { name: 'Console æ”¯æ´', test: () => typeof console !== 'undefined' }
            ];
            
            let results = '';
            checks.forEach(check => {
                const passed = check.test();
                const status = passed ? 'âœ… é€šé' : 'âŒ å¤±æ•—';
                results += `<li>${check.name}: ${status}</li>`;
                log(`${check.name}: ${status}`, passed ? 'success' : 'error');
            });
            
            addResult('ğŸŒ åŸºæœ¬ç’°å¢ƒæª¢æŸ¥', `<ul>${results}</ul>`, 'info');
        }
        
        async function checkExternalResources() {
            log('æª¢æŸ¥å¤–éƒ¨è³‡æº...', 'info');
            
            const resources = [
                { name: 'Bootstrap CSS', url: 'https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css' },
                { name: 'Font Awesome', url: 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css' },
                { name: 'Chart.js', url: 'https://cdn.jsdelivr.net/npm/chart.js' },
                { name: 'Bootstrap JS', url: 'https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js' }
            ];
            
            let results = '';
            for (const resource of resources) {
                try {
                    const response = await fetch(resource.url, { method: 'HEAD' });
                    const status = response.ok ? 'âœ… å¯è¨ªå•' : 'âŒ ç„¡æ³•è¨ªå•';
                    results += `<li>${resource.name}: ${status} (HTTP ${response.status})</li>`;
                    log(`${resource.name}: ${status}`, response.ok ? 'success' : 'error');
                } catch (error) {
                    results += `<li>${resource.name}: âŒ ç¶²è·¯éŒ¯èª¤ (${error.message})</li>`;
                    log(`${resource.name}: ç¶²è·¯éŒ¯èª¤ - ${error.message}`, 'error');
                }
            }
            
            addResult('ğŸ“¦ å¤–éƒ¨è³‡æºæª¢æŸ¥', `<ul>${results}</ul>`, 'info');
        }
        
        async function checkAPIEndpoints() {
            log('æª¢æŸ¥ API ç«¯é»...', 'info');
            
            const endpoints = [
                { name: 'çµ±ä¸€é æ¸¬ API', url: '/api/unified-forecast', method: 'OPTIONS' },
                { name: 'é æ¸¬Agent API', url: '/api/forecast-agent', method: 'OPTIONS' },
                { name: 'çµ±ä¸€é æ¸¬é é¢', url: '/unified-forecast', method: 'GET' },
                { name: 'ä¸»é ', url: '/', method: 'GET' }
            ];
            
            let results = '';
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(endpoint.url, { method: endpoint.method });
                    const status = response.ok ? 'âœ… æ­£å¸¸' : 'âš ï¸ ç•°å¸¸';
                    results += `<li>${endpoint.name}: ${status} (HTTP ${response.status})</li>`;
                    log(`${endpoint.name}: ${status}`, response.ok ? 'success' : 'warning');
                } catch (error) {
                    results += `<li>${endpoint.name}: âŒ éŒ¯èª¤ (${error.message})</li>`;
                    log(`${endpoint.name}: éŒ¯èª¤ - ${error.message}`, 'error');
                }
            }
            
            addResult('ğŸ”Œ API ç«¯é»æª¢æŸ¥', `<ul>${results}</ul>`, 'info');
        }
        
        function checkPageFunctionality() {
            log('æª¢æŸ¥é é¢åŠŸèƒ½...', 'info');
            
            const checks = [
                { name: 'é é¢æ¨™é¡Œ', test: () => document.title.includes('çµ±ä¸€é æ¸¬') },
                { name: 'å°èˆªæ¬„', test: () => document.querySelector('nav') !== null },
                { name: 'ä¸»è¦å®¹å™¨', test: () => document.querySelector('.container') !== null },
                { name: 'é æ¸¬æ§åˆ¶é¢æ¿', test: () => document.querySelector('.card-header') !== null }
            ];
            
            let results = '';
            checks.forEach(check => {
                const passed = check.test();
                const status = passed ? 'âœ… æ­£å¸¸' : 'âŒ ç•°å¸¸';
                results += `<li>${check.name}: ${status}</li>`;
                log(`${check.name}: ${status}`, passed ? 'success' : 'error');
            });
            
            addResult('ğŸ“„ é é¢åŠŸèƒ½æª¢æŸ¥', `<ul>${results}</ul>`, 'info');
        }
        
        function testChartJS() {
            log('æ¸¬è©¦ Chart.js åŠŸèƒ½...', 'info');
            
            if (typeof Chart === 'undefined') {
                addResult('âŒ Chart.js æ¸¬è©¦å¤±æ•—', 'Chart.js æœªè¼‰å…¥ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥æˆ– CDN ç‹€æ…‹', 'error');
                log('Chart.js æœªè¼‰å…¥', 'error');
                return;
            }
            
            try {
                // å‰µå»ºæ¸¬è©¦ canvas
                const testCanvas = document.createElement('canvas');
                testCanvas.id = 'testChart';
                testCanvas.width = 400;
                testCanvas.height = 200;
                document.body.appendChild(testCanvas);
                
                const ctx = testCanvas.getContext('2d');
                const testChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['æ¸¬è©¦1', 'æ¸¬è©¦2', 'æ¸¬è©¦3'],
                        datasets: [{
                            label: 'æ¸¬è©¦æ•¸æ“š',
                            data: [1, 2, 3],
                            borderColor: 'rgb(75, 192, 192)'
                        }]
                    }
                });
                
                addResult('âœ… Chart.js æ¸¬è©¦æˆåŠŸ', 'åœ–è¡¨å‰µå»ºæˆåŠŸï¼ŒChart.js åŠŸèƒ½æ­£å¸¸', 'success');
                log('Chart.js æ¸¬è©¦æˆåŠŸ', 'success');
                
                // æ¸…ç†æ¸¬è©¦å…ƒç´ 
                setTimeout(() => {
                    document.body.removeChild(testCanvas);
                }, 3000);
                
            } catch (error) {
                addResult('âŒ Chart.js æ¸¬è©¦å¤±æ•—', `åœ–è¡¨å‰µå»ºå¤±æ•—: ${error.message}`, 'error');
                log(`Chart.js æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        async function testAPI() {
            log('æ¸¬è©¦ API åŠŸèƒ½...', 'info');
            
            try {
                const response = await fetch('/api/unified-forecast', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'month',
                        periods: 3,
                        enable_ai_analysis: false
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    addResult('âœ… API æ¸¬è©¦æˆåŠŸ', `API éŸ¿æ‡‰æ­£å¸¸ï¼Œç‹€æ…‹: ${data.success}`, 'success');
                    log('API æ¸¬è©¦æˆåŠŸ', 'success');
                } else {
                    addResult('âš ï¸ API æ¸¬è©¦ç•°å¸¸', `HTTP ${response.status}: ${response.statusText}`, 'warning');
                    log(`API æ¸¬è©¦ç•°å¸¸: HTTP ${response.status}`, 'warning');
                }
                
            } catch (error) {
                addResult('âŒ API æ¸¬è©¦å¤±æ•—', `ç¶²è·¯éŒ¯èª¤: ${error.message}`, 'error');
                log(`API æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        function checkConsole() {
            log('æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°...', 'info');
            
            const consoleInfo = `
                <h5>æ§åˆ¶å°æª¢æŸ¥æ­¥é©Ÿï¼š</h5>
                <ol>
                    <li>æŒ‰ F12 æˆ–å³éµé¸æ“‡ã€Œæª¢æŸ¥ã€</li>
                    <li>åˆ‡æ›åˆ°ã€ŒConsoleã€æ¨™ç±¤</li>
                    <li>æŸ¥çœ‹æ˜¯å¦æœ‰ç´…è‰²éŒ¯èª¤è¨Šæ¯</li>
                    <li>æª¢æŸ¥æ˜¯å¦æœ‰ JavaScript è¼‰å…¥å¤±æ•—</li>
                    <li>æŸ¥çœ‹ç¶²è·¯è«‹æ±‚æ˜¯å¦æˆåŠŸ</li>
                </ol>
                <p><strong>å¸¸è¦‹éŒ¯èª¤ï¼š</strong></p>
                <ul>
                    <li>Chart.js è¼‰å…¥å¤±æ•—</li>
                    <li>Bootstrap æ¨£å¼è¼‰å…¥å¤±æ•—</li>
                    <li>API è«‹æ±‚å¤±æ•—</li>
                    <li>JavaScript èªæ³•éŒ¯èª¤</li>
                </ul>
            `;
            
            addResult('ğŸ” æ§åˆ¶å°æª¢æŸ¥æŒ‡å—', consoleInfo, 'info');
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('log').innerHTML = '';
            logCount = 0;
            log('çµæœå·²æ¸…é™¤', 'info');
        }
        
        // é é¢è¼‰å…¥å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            log('è¨ºæ–·å·¥å…·é é¢è¼‰å…¥å®Œæˆ', 'success');
            addResult('ğŸš€ è¨ºæ–·å·¥å…·å°±ç·’', 'é»æ“Šã€Œé–‹å§‹è¨ºæ–·ã€æŒ‰éˆ•é–‹å§‹æª¢æŸ¥ç³»çµ±ç‹€æ…‹', 'success');
        });
        
        // éŒ¯èª¤è™•ç†
        window.addEventListener('error', function(e) {
            log(`JavaScript éŒ¯èª¤: ${e.message}`, 'error');
            addResult('âŒ JavaScript éŒ¯èª¤', `éŒ¯èª¤è¨Šæ¯: ${e.message}<br>æª”æ¡ˆ: ${e.filename}<br>è¡Œè™Ÿ: ${e.lineno}`, 'error');
        });
        
        window.addEventListener('unhandledrejection', function(e) {
            log(`æœªè™•ç†çš„ Promise æ‹’çµ•: ${e.reason}`, 'error');
            addResult('âŒ Promise éŒ¯èª¤', `éŒ¯èª¤åŸå› : ${e.reason}`, 'error');
        });
    </script>
</body>
</html>
