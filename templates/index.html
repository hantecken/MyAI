<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NL2Cube 智慧分析系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 20px;
            padding: 30px;
        }
        .navbar {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(10px);
            border-radius: 15px;
            margin: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        .navbar-brand {
            font-weight: bold;
            color: #667eea !important;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
        }
        .btn-primary:hover {
            background: linear-gradient(45deg, #764ba2, #667eea);
            transform: translateY(-2px);
        }
        .form-control {
            border-radius: 15px;
            border: 2px solid #e9ecef;
            padding: 15px 20px;
        }
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }
        .table {
            border-radius: 15px;
            overflow: hidden;
        }
        .table th {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        .alert {
            border-radius: 15px;
            border: none;
        }
        .positive {
            color: #28a745;
        }
        .negative {
            color: #dc3545;
        }
        .neutral {
            color: #6c757d;
        }
        .page-content {
            display: none;
        }
        .page-content.active {
            display: block;
        }
        .nav-link {
            color: #667eea !important;
        }
        
        /* 分析摘要報告樣式 */
        .analysis-summary {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 20px;
            border-left: 5px solid #28a745;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .summary-section {
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
            border-left: 3px solid #667eea;
        }
        
        .summary-section:last-child {
            margin-bottom: 0;
        }
        
        .summary-section strong {
            color: #495057;
            font-weight: 600;
        }
            border-radius: 10px;
            margin: 2px 0;
            transition: all 0.3s ease;
        }
        .nav-link:hover {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white !important;
            transform: translateX(5px);
        }
        .nav-link.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white !important;
        }
        .development-card {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
        }
        
        /* 範例按鈕樣式 */
        .example-btn {
            transition: all 0.3s ease;
            border-radius: 10px;
            font-size: 0.9rem;
            padding: 12px 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .example-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .example-btn:active {
            transform: translateY(0);
        }
        
        .example-btn.btn-primary {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* 專業報告樣式 */
        .report-content {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 20px;
            margin-top: 15px;
        }
        
        .report-content h1 {
            color: #667eea;
            font-weight: bold;
            margin-bottom: 20px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        
        .report-content h2 {
            color: #764ba2;
            font-weight: bold;
            margin-top: 25px;
            margin-bottom: 15px;
            border-left: 4px solid #764ba2;
            padding-left: 15px;
        }
        
        .report-content h3 {
            color: #495057;
            font-weight: 600;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        
        .report-content p {
            line-height: 1.6;
            margin-bottom: 15px;
            text-align: justify;
        }
        
        .report-content strong {
            color: #667eea;
            font-weight: bold;
        }
        
        .report-content em {
            color: #764ba2;
            font-style: italic;
        }
        
        .report-info {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        /* 公司介紹頁面樣式 */
        .company-stats {
            margin-top: 20px;
        }
        
        .stat-item {
            padding: 10px;
            border-radius: 10px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            transition: all 0.3s ease;
        }
        
        .stat-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .stat-item h4 {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-item small {
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* 時間軸樣式 */
        .timeline {
            position: relative;
            padding-left: 30px;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, #007bff, #28a745, #17a2b8, #ffc107, #dc3545);
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 30px;
        }
        
        .timeline-marker {
            position: absolute;
            left: -22px;
            top: 0;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.2);
        }
        
        .timeline-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            margin-left: 20px;
            transition: all 0.3s ease;
        }
        
        .timeline-content:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        
        .timeline-content h6 {
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .timeline-content img {
            transition: all 0.3s ease;
        }
        
        .timeline-content img:hover {
            transform: scale(1.05);
        }

        /* 服務卡片樣式 */
        .service-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 15px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            height: 100%;
        }
        
        .service-card:hover {
            transform: translateY(-5px);
            border-color: #007bff;
            box-shadow: 0 10px 25px rgba(0,123,255,0.2);
        }
        
        .service-card i {
            transition: all 0.3s ease;
        }
        
        .service-card:hover i {
            transform: scale(1.1);
        }
        
        .service-card h6 {
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .service-card p {
            line-height: 1.5;
        }

        /* SQL 轉換區域樣式 */
        #sqlConversionCard {
            border-left: 4px solid #17a2b8;
        }
        
        #sqlConversionCard .alert {
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 0;
        }
        
        #naturalQueryText {
            background-color: #f8f9fa;
            border-color: #dee2e6;
            color: #495057;
        }
        
        #generatedSQLText {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
            font-weight: 500;
        }
        
        #sqlConversionCard .btn-sm {
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
            border-radius: 0.375rem;
        }
        
        #sqlConversionCard .btn-success {
            background-color: #28a745;
            border-color: #28a745;
        }
        
        #sqlConversionCard .btn-success:hover {
            background-color: #218838;
            border-color: #1e7e34;
        }

        /* 資料庫資料查詢頁面樣式 */
        #data-query .card {
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        #data-query .card-header {
            border-radius: 15px 15px 0 0;
        }
        
        #data-query .btn-outline-info {
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        #data-query .btn-outline-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        
        #queryResults2 {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        #sqlConversionCard2 {
            border-left: 4px solid #17a2b8;
        }
        
        #sqlConversionCard2 .alert {
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 0;
        }
        
        #naturalQueryText2 {
            background-color: #f8f9fa;
            border-color: #dee2e6;
            color: #495057;
        }
        
        #generatedSQLText2 {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
            font-weight: 500;
        }

        /* 聊天視窗樣式 */
        .chat-message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
        }
        
        .chat-message.user {
            justify-content: flex-end;
        }
        
        .chat-message.ai {
            justify-content: flex-start;
        }
        
        .message-bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            position: relative;
        }
        
        .message-bubble.user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 5px;
        }
        
        .message-bubble.ai {
            background: white;
            color: #333;
            border: 1px solid #e9ecef;
            border-bottom-left-radius: 5px;
        }
        
        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 8px;
            font-size: 14px;
        }
        
        .message-avatar.user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .message-avatar.ai {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }
        
        .chat-typing {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .typing-dots {
            display: flex;
            gap: 4px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #6c757d;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* === 公告頁面 RWD 與主要區塊 RWD === */
        @media (max-width: 991.98px) {
            .main-container {
                padding: 10px;
            }
            .announcement-card .card-body {
                padding: 1rem 0.5rem;
            }
            .announcement-card .card-title {
                font-size: 1.1rem;
            }
            .announcement-card .card-header h6 {
                font-size: 1rem;
            }
            .btn-group[role="group"] {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            .btn-group[role="group"] .btn {
                flex: 1 1 45%;
                min-width: 120px;
                margin-bottom: 0.5rem;
                font-size: 0.95rem;
                padding: 0.5rem 0.5rem;
            }
            #announcementList .row > [class^="col-"] {
                flex: 0 0 100%;
                max-width: 100%;
            }
            .stat-item h4 {
                font-size: 1.1rem;
            }
            .stat-item small {
                font-size: 0.8rem;
            }
        }
        @media (max-width: 767.98px) {
            .main-container {
                padding: 5px;
            }
            .announcement-card .card {
                margin-bottom: 1rem;
            }
            .announcement-card .card-title {
                font-size: 1rem;
            }
            .announcement-card .card-header h6 {
                font-size: 0.95rem;
            }
            .btn-group[role="group"] {
                flex-direction: column;
                gap: 0.3rem;
            }
            .btn-group[role="group"] .btn {
                width: 100%;
                min-width: 0;
                font-size: 0.95rem;
                padding: 0.5rem 0.5rem;
            }
            #announcementList .row > [class^="col-"] {
                flex: 0 0 100%;
                max-width: 100%;
            }
            .stat-item {
                margin-bottom: 0.5rem;
            }
            .stat-item h4 {
                font-size: 1rem;
            }
            .stat-item small {
                font-size: 0.75rem;
            }
        }
        @media (max-width: 575.98px) {
            .main-container {
                padding: 2px;
            }
            .announcement-card .card-body {
                padding: 0.5rem 0.2rem;
            }
            .announcement-card .card-title {
                font-size: 0.95rem;
            }
            .announcement-card .card-header h6 {
                font-size: 0.9rem;
            }
            .btn-group[role="group"] .btn {
                font-size: 0.9rem;
                padding: 0.4rem 0.3rem;
            }
            .stat-item h4 {
                font-size: 0.95rem;
            }
            .stat-item small {
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <!-- 導航欄 -->
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-cube"></i> 大頭家A鐵口智慧大師
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showPage('company')">
                            <i class="fas fa-building"></i> 公司介紹
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#" onclick="showPage('analysis')">
                            <i class="fas fa-search"></i> 智慧分析查詢
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showPage('forecast-agent')">
                            <i class="fas fa-chart-line"></i> 預測Agent
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showPage('database')">
                            <i class="fas fa-database"></i> 資料庫維護
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showPage('data-query')">
                            <i class="fas fa-search"></i> 資料庫資料查詢
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showPage('announcement')">
                            <i class="fas fa-bullhorn"></i> 公告
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <!-- 公司介紹頁面 -->
        <div id="company" class="page-content">
            <div class="main-container">
                <div class="text-center mb-4">
                    <h1><i class="fas fa-building text-primary"></i> 公司介紹</h1>
                </div>

                <!-- 公司概覽 -->
                <div class="card shadow-lg mb-4">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-3 text-center mb-3 mb-md-0">
                                <div class="company-logo mb-3">
                                    <i class="fas fa-user-secret fa-5x text-primary"></i>
                                </div>
                                <div class="company-stats">
                                    <div class="row text-center">
                                        <div class="col-4">
                                            <div class="stat-item">
                                                <h4 class="text-primary mb-0">50+</h4>
                                                <small class="text-muted">專業團隊</small>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <div class="stat-item">
                                                <h4 class="text-success mb-0">200+</h4>
                                                <small class="text-muted">成功案例</small>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <div class="stat-item">
                                                <h4 class="text-info mb-0">5年</h4>
                                                <small class="text-muted">服務經驗</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-9">
                                <h2 class="mb-2">007資訊股份有限公司</h2>
                                <p class="text-muted mb-2">007 Information Technology Co., Ltd.</p>
                                <p class="mb-3">
                                    007資訊公司成立於2020年，致力於智慧數據分析、雲端解決方案與AI應用開發，協助企業數位轉型與提升營運效率。
                                    我們擁有專業的軟體開發團隊，提供從顧問諮詢、系統設計、到維運服務的一站式解決方案。
                                </p>
                                <ul class="list-group list-group-flush mb-3">
                                    <li class="list-group-item bg-transparent"><strong>核心願景：</strong> 以創新科技驅動企業成長，成為智慧數據應用的領導品牌。</li>
                                    <li class="list-group-item bg-transparent"><strong>主要服務：</strong> 大數據分析平台、AI模型導入、雲端系統建置、企業流程自動化、IT顧問服務。</li>
                                    <li class="list-group-item bg-transparent"><strong>合作產業：</strong> 金融、零售、製造、醫療、教育等多元領域。</li>
                                </ul>
                                <div class="mt-3">
                                    <h5>聯絡資訊</h5>
                                    <p class="mb-1"><i class="fas fa-map-marker-alt"></i> 台北市信義區松高路7號20樓</p>
                                    <p class="mb-1"><i class="fas fa-phone"></i> (02) 1234-0070</p>
                                    <p class="mb-1"><i class="fas fa-envelope"></i> service@007it.com.tw</p>
                                    <p class="mb-0"><i class="fas fa-globe"></i> www.007it.com.tw</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 公司發展歷程 -->
                <div class="card shadow-lg mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5><i class="fas fa-history"></i> 🚀 公司發展歷程</h5>
                    </div>
                    <div class="card-body">
                        <div class="timeline">
                            <div class="timeline-item">
                                <div class="timeline-marker bg-primary"></div>
                                <div class="timeline-content">
                                    <h6 class="text-primary">2020年 - 公司成立</h6>
                                    <p class="mb-2">007資訊公司正式成立，初期專注於企業IT顧問服務，為客戶提供系統整合與流程優化解決方案。</p>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <img src="https://images.unsplash.com/photo-1551434678-e076c223a692?w=300&h=200&fit=crop" 
                                                 class="img-fluid rounded" alt="公司成立">
                                        </div>
                                        <div class="col-md-6">
                                            <ul class="list-unstyled">
                                                <li><i class="fas fa-check text-success"></i> 完成首個企業ERP系統導入</li>
                                                <li><i class="fas fa-check text-success"></i> 建立核心技術團隊</li>
                                                <li><i class="fas fa-check text-success"></i> 獲得ISO 27001資安認證</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="timeline-item">
                                <div class="timeline-marker bg-success"></div>
                                <div class="timeline-content">
                                    <h6 class="text-success">2021年 - 技術突破</h6>
                                    <p class="mb-2">開始投入大數據分析技術研發，成功開發智慧數據分析平台，為客戶提供更精準的商業洞察。</p>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <img src="https://images.unsplash.com/photo-1551288049-bebda4e38f71?w=300&h=200&fit=crop" 
                                                 class="img-fluid rounded" alt="技術突破">
                                        </div>
                                        <div class="col-md-6">
                                            <ul class="list-unstyled">
                                                <li><i class="fas fa-check text-success"></i> 推出智慧數據分析平台</li>
                                                <li><i class="fas fa-check text-success"></i> 服務客戶數突破50家</li>
                                                <li><i class="fas fa-check text-success"></i> 獲得經濟部SBIR補助</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="timeline-item">
                                <div class="timeline-marker bg-info"></div>
                                <div class="timeline-content">
                                    <h6 class="text-info">2022年 - AI應用發展</h6>
                                    <p class="mb-2">全面投入AI技術研發，推出多項智慧應用解決方案，協助客戶實現數位轉型目標。</p>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <img src="https://images.unsplash.com/photo-1677442136019-21780ecad995?w=300&h=200&fit=crop" 
                                                 class="img-fluid rounded" alt="AI應用">
                                        </div>
                                        <div class="col-md-6">
                                            <ul class="list-unstyled">
                                                <li><i class="fas fa-check text-success"></i> 開發AI預測模型</li>
                                                <li><i class="fas fa-check text-success"></i> 建立雲端服務平台</li>
                                                <li><i class="fas fa-check text-success"></i> 獲得微軟金牌合作夥伴認證</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="timeline-item">
                                <div class="timeline-marker bg-warning"></div>
                                <div class="timeline-content">
                                    <h6 class="text-warning">2023年 - 業務擴展</h6>
                                    <p class="mb-2">業務範圍擴展至海外市場，建立國際合作夥伴關係，為更多企業提供全球化服務。</p>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <img src="https://images.unsplash.com/photo-1552664730-d307ca884978?w=300&h=200&fit=crop" 
                                                 class="img-fluid rounded" alt="業務擴展">
                                        </div>
                                        <div class="col-md-6">
                                            <ul class="list-unstyled">
                                                <li><i class="fas fa-check text-success"></i> 進軍東南亞市場</li>
                                                <li><i class="fas fa-check text-success"></i> 建立海外研發中心</li>
                                                <li><i class="fas fa-check text-success"></i> 獲得亞太區最佳IT服務獎</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="timeline-item">
                                <div class="timeline-marker bg-danger"></div>
                                <div class="timeline-content">
                                    <h6 class="text-danger">2024年 - 創新突破</h6>
                                    <p class="mb-2">持續創新研發，推出新一代智慧企業解決方案，成為業界技術領導者。</p>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <img src="https://images.unsplash.com/photo-1518186285589-2f7649de83e0?w=300&h=200&fit=crop" 
                                                 class="img-fluid rounded" alt="創新突破">
                                        </div>
                                        <div class="col-md-6">
                                            <ul class="list-unstyled">
                                                <li><i class="fas fa-check text-success"></i> 推出AI驅動企業平台</li>
                                                <li><i class="fas fa-check text-success"></i> 服務客戶數突破200家</li>
                                                <li><i class="fas fa-check text-success"></i> 獲得國家品質獎肯定</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 核心服務 -->
                <div class="card shadow-lg mb-4">
                    <div class="card-header bg-success text-white">
                        <h5><i class="fas fa-cogs"></i> ⚙️ 核心服務</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <div class="service-card text-center p-3">
                                    <i class="fas fa-chart-line fa-3x text-primary mb-3"></i>
                                    <h6>大數據分析</h6>
                                    <p class="text-muted small">智慧數據分析平台，提供即時商業洞察與預測分析</p>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="service-card text-center p-3">
                                    <i class="fas fa-robot fa-3x text-success mb-3"></i>
                                    <h6>AI應用開發</h6>
                                    <p class="text-muted small">客製化AI模型開發，協助企業實現智慧化營運</p>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="service-card text-center p-3">
                                    <i class="fas fa-cloud fa-3x text-info mb-3"></i>
                                    <h6>雲端解決方案</h6>
                                    <p class="text-muted small">企業級雲端架構設計與建置，確保系統穩定與安全</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 智慧分析查詢頁面 -->
        <div id="analysis" class="page-content active">
            <div class="main-container">
                <div class="text-center mb-4">
                    <h1><i class="fas fa-search text-primary"></i> 大頭家A鐵口智慧大師</h1>
                    <p class="text-muted">您可以透過自然語言查詢業績比較，系統將自動分析貢獻差異的主因。</p>
                </div>

                <!-- 查詢表單 -->
                <div class="card mb-4">
                    <div class="card-body">
                        <form id="queryForm">
                            <div class="mb-3">
                                <label for="queryInput" class="form-label">
                                    <i class="fas fa-comment"></i> 請輸入您的自然語言查詢：
                                </label>
                                <input type="text" class="form-control" id="queryInput" 
                                       value="這個月的業績和上月相比是好還是差? 差異來自哪些產品?"
                                       placeholder="試試看輸入 '比較本季和上季的業績，並按業務員分析'">
                            </div>
                            
                            <!-- 查詢範例區域 -->
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-lightbulb"></i> 💡 查詢範例 (點擊選擇)：
                                </label>
                                <div class="row">
                                    <div class="col-md-6 mb-2">
                                        <button type="button" class="btn btn-outline-primary w-100 example-btn" 
                                                data-query="這個月的業績和上月相比是好還是差? 差異來自哪些產品?">
                                            <i class="fas fa-chart-line"></i> 本月 vs 上月業績比較
                                        </button>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <button type="button" class="btn btn-outline-success w-100 example-btn" 
                                                data-query="2025年Q1月銷售業績">
                                            <i class="fas fa-calendar-quarter"></i> 2025年Q1季度業績
                                        </button>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <button type="button" class="btn btn-outline-info w-100 example-btn" 
                                                data-query="分析各區域的銷售表現，找出表現最好的地區">
                                            <i class="fas fa-map-marker-alt"></i> 區域銷售表現分析
                                        </button>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <button type="button" class="btn btn-outline-warning w-100 example-btn" 
                                                data-query="比較不同客戶等級的消費行為，分析忠誠度影響">
                                            <i class="fas fa-crown"></i> 客戶等級消費分析
                                        </button>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <button type="button" class="btn btn-outline-danger w-100 example-btn" 
                                                data-query="分析各產品類別的銷售趨勢，找出熱門商品">
                                            <i class="fas fa-box"></i> 產品類別銷售趨勢
                                        </button>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <button type="button" class="btn btn-outline-secondary w-100 example-btn" 
                                                data-query="2025年Q1月與去年Q2銷售業績比較">
                                            <i class="fas fa-calendar-alt"></i> 季度比較分析
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-center">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-rocket"></i> 🚀 開始分析
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- 載入中 -->
                <div id="loading" class="loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">載入中...</span>
                    </div>
                    <p class="mt-3">請稍候，智慧分析引擎正在運轉...</p>
                </div>

                <!-- 分析結果 -->
                <div id="results" style="display: none;">
                    <!-- 分析總結 -->
                    <div class="card mb-4">
                        <div class="card-header bg-success text-white">
                            <h5><i class="fas fa-chart-line"></i> 📊 分析總結報告 (NLG)</h5>
                        </div>
                        <div class="card-body">
                            <div id="summary" class="alert alert-success"></div>
                            
                            <!-- 語音播放控制 -->
                            <div id="voiceControlSection" style="display: none;" class="mt-3">
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-volume-up"></i> 🔊 語音播放功能</h6>
                                    <p class="mb-2">點擊下方按鈕收聽分析總結報告的語音版本：</p>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-2">
                                            <button id="generateVoiceBtn" class="btn btn-primary btn-sm w-100" onclick="generateVoiceSummary()">
                                                <i class="fas fa-microphone"></i> 🎤 生成語音總結
                                            </button>
                                        </div>
                                        <div class="col-md-6 mb-2">
                                            <button id="playVoiceBtn" class="btn btn-success btn-sm w-100" onclick="playVoiceSummary()" disabled>
                                                <i class="fas fa-play"></i> ▶️ 播放語音
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- 播放速度控制 -->
                                    <div class="row mt-2">
                                        <div class="col-md-12">
                                            <label for="playbackSpeed" class="form-label">
                                                <i class="fas fa-tachometer-alt"></i> 🎵 播放速度：
                                            </label>
                                            <select id="playbackSpeed" class="form-select form-select-sm" onchange="changePlaybackSpeed()">
                                                <option value="0.5">0.5x (慢速)</option>
                                                <option value="0.75">0.75x (較慢)</option>
                                                <option value="1.0">1.0x (正常)</option>
                                                <option value="1.25">1.25x (較快)</option>
                                                <option value="1.5" selected>1.5x (快速 - 預設)</option>
                                                <option value="2.0">2.0x (倍速)</option>
                                            </select>
                                            <small class="text-muted">選擇播放速度，預設為1.5倍速（加快1/2）</small>
                                        </div>
                                    </div>
                                    
                                    <div id="voiceStatus" class="mt-2" style="display: none;">
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle"></i> 
                                            <span id="voiceStatusText"></span>
                                        </small>
                                    </div>
                                    
                                    <div id="voiceContent" class="mt-2" style="display: none;">
                                        <small class="text-muted">
                                            <strong>語音內容：</strong><br>
                                            <span id="voiceContentText"></span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI 智慧助手和專業報告按鈕 -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5><i class="fas fa-tools"></i> 🛠️ 進階分析工具</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <button class="btn btn-info btn-lg w-100" type="button" data-bs-toggle="modal" data-bs-target="#aiChatModal">
                                        <i class="fas fa-robot"></i> 🤖 AI 智慧助手
                                    </button>
                                    <small class="text-muted d-block mt-2">
                                        <i class="fas fa-lightbulb"></i> 針對分析建議與 AI 進行討論
                                    </small>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <button class="btn btn-success btn-lg w-100" type="button" data-bs-toggle="modal" data-bs-target="#reportModal">
                                        <i class="fas fa-file-alt"></i> 📋 專業建議報告書
                                    </button>
                                    <small class="text-muted d-block mt-2">
                                        <i class="fas fa-lightbulb"></i> 生成包含主旨、分析說明、改善建議的專業報告
                                    </small>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <button class="btn btn-warning btn-lg w-100" type="button" onclick="window.open('/unified-forecast-test', '_blank')">
                                        <i class="fas fa-chart-line"></i> 📈 業績預測
                                    </button>
                                    <small class="text-muted d-block mt-2">
                                        <i class="fas fa-lightbulb"></i> 跳轉到統一預測測試頁面
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 關鍵指標 -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5><i class="fas fa-chart-bar"></i> 📈 關鍵指標 (KPI)</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="metric-card">
                                        <h6>本期銷售額</h6>
                                        <h4 id="currentSales">-</h4>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="metric-card">
                                        <h6>前期銷售額</h6>
                                        <h4 id="lastSales">-</h4>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="metric-card">
                                        <h6>業績差異</h6>
                                        <h4 id="diff">-</h4>
                                        <small id="percentageDiff">-</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 貢獻度排行 -->
                    <div class="card mb-4">
                        <div class="card-header bg-info text-white">
                            <h5><i class="fas fa-list-ol"></i> 📋 貢獻度排行</h5>
                        </div>
                        <div class="card-body">
                            <!-- Drill Down 維度選擇 -->
                            <div id="drillDownSection" style="display: none;" class="mb-3">
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-search-plus"></i> 🔍 Drill Down 分析</h6>
                                    <p class="mb-2">選擇要下鑽分析的維度：</p>
                                    <div id="drillDownOptions" class="d-flex flex-wrap gap-2">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-hover" id="driverTable">
                                    <thead>
                                        <tr>
                                            <th>分析維度</th>
                                            <th>本期銷售額</th>
                                            <th>前期銷售額</th>
                                            <th>差異</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="driverTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Drill Down 結果 -->
                    <div id="drillDownResults" class="card mb-4" style="display: none;">
                        <div class="card-header bg-warning text-dark">
                            <h5><i class="fas fa-search-plus"></i> 🔍 Drill Down 分析結果</h5>
                            <small id="drillDownContext"></small>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="drillDownTable">
                                    <thead>
                                        <tr>
                                            <th>下鑽維度</th>
                                            <th>本期銷售額</th>
                                            <th>前期銷售額</th>
                                            <th>差異</th>
                                        </tr>
                                    </thead>
                                    <tbody id="drillDownTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- 圖表 -->
                    <div class="card" id="chartContainer">
                        <div class="card-header bg-warning text-dark">
                            <h5><i class="fas fa-chart-pie"></i> 📊 差異原因數據圖表</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="chartCanvas" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI 智慧助手模態視窗 -->
        <div class="modal fade" id="aiChatModal" tabindex="-1" aria-labelledby="aiChatModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-info text-white">
                        <h5 class="modal-title" id="aiChatModalLabel">
                            <i class="fas fa-robot"></i> 🤖 AI 智慧助手
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="chatMessages" class="chat-messages mb-3" style="height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 10px; padding: 15px; background-color: #f8f9fa;">
                            <div class="text-center text-muted">
                                <i class="fas fa-comments"></i> 開始與 AI 討論分析建議...
                            </div>
                        </div>
                        <div class="input-group">
                            <input type="text" id="chatInput" class="form-control" placeholder="輸入您的問題或想法..." maxlength="500">
                            <button class="btn btn-primary" type="button" id="sendChatBtn">
                                <i class="fas fa-paper-plane"></i> 發送
                            </button>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-lightbulb"></i> 提示：您可以詢問「如何改善銷售表現？」、「這個建議的具體實施步驟？」等問題
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 專業報告模態視窗 -->
        <div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title" id="reportModalLabel">
                            <i class="fas fa-file-alt"></i> 📋 專業建議報告書
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="reportType" class="form-label">報告類型：</label>
                                <select class="form-select" id="reportType">
                                    <option value="general">綜合經營分析報告</option>
                                    <option value="performance">銷售績效分析報告</option>
                                    <option value="strategy">經營策略規劃報告</option>
                                    <option value="risk">風險評估管理報告</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">操作：</label>
                                <div>
                                    <button class="btn btn-success" type="button" id="generateReportBtn">
                                        <i class="fas fa-file-alt"></i> 生成專業報告
                                    </button>
                                    <button class="btn btn-info btn-sm" type="button" id="downloadReportBtn" style="display: none;">
                                        <i class="fas fa-download"></i> 下載報告
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="reportContent" class="mt-3" style="display: none;">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle"></i> 報告資訊</h6>
                                <small id="reportInfo">報告生成中...</small>
                            </div>
                            <div id="reportText" class="border rounded p-3" style="background-color: #f8f9fa; max-height: 500px; overflow-y: auto;">
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-lightbulb"></i> 提示：報告將基於當前分析結果生成，包含主旨、分析說明、改善建議、規劃時程和結論
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 業績預測模態視窗 -->
        <div class="modal fade" id="forecastModal" tabindex="-1" aria-labelledby="forecastModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header bg-warning text-dark">
                        <h5 class="modal-title" id="forecastModalLabel">
                            <i class="fas fa-chart-line"></i> 📈 業績預測
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label for="forecastDimension" class="form-label">預測維度：</label>
                                <select class="form-select" id="forecastDimension" onchange="onForecastDimensionChange()">
                                    <option value="all">全部</option>
                                    <option value="product">產品</option>
                                    <option value="customer">客戶</option>
                                </select>
                            </div>
                            <div class="col-md-3" id="forecastDimensionValueCol" style="display:none;">
                                <label for="forecastDimensionValue" class="form-label" id="forecastDimensionValueLabel">細項：</label>
                                <select class="form-select" id="forecastDimensionValue"></select>
                            </div>
                            <div class="col-md-2">
                                <label for="forecastType" class="form-label">預測類型：</label>
                                <select class="form-select" id="forecastType">
                                    <option value="month">月度預測</option>
                                    <option value="quarter">季度預測</option>
                                    <option value="year">年度預測</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="forecastMethod" class="form-label">預測方法：</label>
                                <select class="form-select" id="forecastMethod">
                                    <option value="arima">ARIMA（自迴歸整合移動平均）</option>
                                    <option value="ets">ETS（指數平滑）</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="forecastPeriods" class="form-label">預測期數：</label>
                                <input type="number" class="form-control" id="forecastPeriods" value="12" min="1" max="60">
                                <small class="text-muted">建議：月度12期、季度4期、年度3期</small>
                            </div>
                            <div class="col-md-1">
                                <label class="form-label">操作：</label>
                                <div>
                                    <button class="btn btn-warning" type="button" id="generateForecastBtn">
                                        <i class="fas fa-chart-line"></i> 生成預測
                                    </button>
                                    <button class="btn btn-info btn-sm" type="button" id="downloadForecastBtn" style="display: none;">
                                        <i class="fas fa-download"></i> 下載預測
                                    </button>
                                    <button class="btn btn-success btn-sm" type="button" id="downloadChartBtn" style="display: none;" onclick="downloadChart()">
                                        <i class="fas fa-image"></i> 下載圖表
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="forecastContent" class="mt-3" style="display: none;">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle"></i> 預測資訊</h6>
                                <small id="forecastInfo">預測生成中...</small>
                            </div>
                            <!-- 預測圖表區域 -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6><i class="fas fa-chart-line"></i> 預測趨勢圖</h6>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="forecastChart" width="400" height="300" style="height: 300px;"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="forecastText" class="border rounded p-3" style="background-color: #f8f9fa; max-height: 500px; overflow-y: auto;">
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-lightbulb"></i> 提示：使用 ARIMA 時間序列模型，基於歷史數據進行預測，結果僅供參考
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 資料庫維護頁面 -->
        <div id="database" class="page-content">
            <div class="main-container">
                <div class="text-center mb-4">
                    <h1><i class="fas fa-database text-primary"></i> 資料庫維護</h1>
                    <p class="text-muted">SQLite 資料庫檢視與管理工具</p>
                </div>

                <!-- 資料庫資訊 -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5><i class="fas fa-info-circle"></i> 📊 資料庫資訊</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>資料庫檔案</h6>
                                <p class="text-muted">sales_cube.db</p>
                            </div>
                            <div class="col-md-6">
                                <h6>資料表數量</h6>
                                <p class="text-muted" id="tableCount">載入中...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 資料表選擇 -->
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5><i class="fas fa-table"></i> 📋 資料表檢視</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="tableSelect" class="form-label">選擇資料表：</label>
                                <select class="form-select" id="tableSelect">
                                    <option value="">請選擇資料表...</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">操作：</label>
                                <div>
                                    <button class="btn btn-primary btn-sm" onclick="loadTableData()">
                                        <i class="fas fa-eye"></i> 檢視資料
                                    </button>
                                    <button class="btn btn-info btn-sm" onclick="showTableSchema()">
                                        <i class="fas fa-info"></i> 檢視結構
                                    </button>
                                    <button class="btn btn-warning btn-sm" onclick="exportTableData()">
                                        <i class="fas fa-download"></i> 匯出資料
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 資料表結構 -->
                <div class="card mb-4" id="schemaCard" style="display: none;">
                    <div class="card-header bg-info text-white">
                        <h5><i class="fas fa-info"></i> 🔧 資料表結構</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="schemaTable">
                                <thead>
                                    <tr>
                                        <th>欄位名稱</th>
                                        <th>資料類型</th>
                                        <th>是否為空</th>
                                        <th>預設值</th>
                                        <th>主鍵</th>
                                    </tr>
                                </thead>
                                <tbody id="schemaTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 資料內容 -->
                <div class="card mb-4" id="dataCard" style="display: none;">
                    <div class="card-header bg-warning text-dark">
                        <h5><i class="fas fa-list"></i> 📄 資料內容</h5>
                        <small id="dataInfo">載入中...</small>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="dataTable">
                                <thead id="dataTableHead">
                                </thead>
                                <tbody id="dataTableBody">
                                </tbody>
                            </table>
                        </div>
                        <!-- 分頁控制 -->
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div>
                                <span id="paginationInfo">顯示 1-10 筆，共 0 筆</span>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-primary" onclick="previousPage()" id="prevBtn" disabled>
                                    <i class="fas fa-chevron-left"></i> 上一頁
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="nextPage()" id="nextBtn" disabled>
                                    下一頁 <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SQL 查詢工具 -->
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <h5><i class="fas fa-code"></i> 💻 查詢工具</h5>
                    </div>
                    <div class="card-body">
                        <!-- 查詢模式選擇 -->
                        <div class="mb-3">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="queryMode" id="sqlMode" value="sql" checked>
                                <label class="form-check-label" for="sqlMode">
                                    <i class="fas fa-code"></i> SQL 查詢
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="queryMode" id="naturalMode" value="natural">
                                <label class="form-check-label" for="naturalMode">
                                    <i class="fas fa-comments"></i> 自然語言查詢
                                </label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="sqlQuery" class="form-label" id="queryLabel">SQL 查詢：</label>
                            <textarea class="form-control" id="sqlQuery" rows="3" 
                                      placeholder="輸入 SQL 查詢語句，例如：SELECT * FROM dim_product LIMIT 10"></textarea>
                        </div>
                        
                        <!-- 自然語言查詢範例 -->
                        <div id="naturalExamples" class="mb-3" style="display: none;">
                            <label class="form-label">查詢範例：</label>
                            <div class="row">
                                <div class="col-md-6 mb-2">
                                    <button type="button" class="btn btn-outline-info btn-sm w-100" 
                                            onclick="setNaturalQuery('顯示所有產品')">
                                        顯示所有產品
                                    </button>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <button type="button" class="btn btn-outline-info btn-sm w-100" 
                                            onclick="setNaturalQuery('查詢客戶銷售額')">
                                        查詢客戶銷售額
                                    </button>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <button type="button" class="btn btn-outline-info btn-sm w-100" 
                                            onclick="setNaturalQuery('顯示前10筆銷售記錄')">
                                        顯示前10筆銷售記錄
                                    </button>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <button type="button" class="btn btn-outline-info btn-sm w-100" 
                                            onclick="setNaturalQuery('統計各產品銷售額')">
                                        統計各產品銷售額
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button class="btn btn-danger" onclick="executeSQL()">
                                <i class="fas fa-play"></i> 執行查詢
                            </button>
                            <button class="btn btn-secondary" onclick="clearSQL()">
                                <i class="fas fa-eraser"></i> 清除
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 資料庫資料查詢頁面 -->
        <div id="data-query" class="page-content">
            <div class="main-container">
                <div class="text-center mb-4">
                    <h1><i class="fas fa-search text-primary"></i> 資料庫資料查詢</h1>
                    <p class="text-muted">使用自然語言或SQL查詢資料庫中的資料</p>
                </div>

                <!-- 查詢工具 -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5><i class="fas fa-code"></i> 💻 查詢工具</h5>
                    </div>
                    <div class="card-body">
                        <!-- 查詢模式選擇 -->
                        <div class="mb-3">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="queryMode2" id="sqlMode2" value="sql" checked>
                                <label class="form-check-label" for="sqlMode2">
                                    <i class="fas fa-code"></i> SQL 查詢
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="queryMode2" id="naturalMode2" value="natural">
                                <label class="form-check-label" for="naturalMode2">
                                    <i class="fas fa-comments"></i> 自然語言查詢
                                </label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="sqlQuery2" class="form-label" id="queryLabel2">SQL 查詢：</label>
                            <textarea class="form-control" id="sqlQuery2" rows="3" 
                                      placeholder="輸入 SQL 查詢語句，例如：SELECT * FROM dim_product LIMIT 10"></textarea>
                        </div>
                        
                        <!-- 自然語言查詢範例 -->
                        <div id="naturalExamples2" class="mb-3" style="display: none;">
                            <label class="form-label">查詢範例：</label>
                            <div class="row">
                                <div class="col-md-6 mb-2">
                                    <button type="button" class="btn btn-outline-info btn-sm w-100" 
                                            onclick="setNaturalQuery2('顯示所有產品')">
                                        顯示所有產品
                                    </button>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <button type="button" class="btn btn-outline-info btn-sm w-100" 
                                            onclick="setNaturalQuery2('查詢客戶銷售額')">
                                        查詢客戶銷售額
                                    </button>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <button type="button" class="btn btn-outline-info btn-sm w-100" 
                                            onclick="setNaturalQuery2('顯示前10筆銷售記錄')">
                                        顯示前10筆銷售記錄
                                    </button>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <button type="button" class="btn btn-outline-info btn-sm w-100" 
                                            onclick="setNaturalQuery2('統計各產品銷售額')">
                                        統計各產品銷售額
                                    </button>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <button type="button" class="btn btn-outline-info btn-sm w-100" 
                                            onclick="setNaturalQuery2('查詢業務員業績')">
                                        查詢業務員業績
                                    </button>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <button type="button" class="btn btn-outline-info btn-sm w-100" 
                                            onclick="setNaturalQuery2('顯示各地區銷售情況')">
                                        顯示各地區銷售情況
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary" onclick="executeSQL2()">
                                <i class="fas fa-play"></i> 執行查詢
                            </button>
                            <button class="btn btn-secondary" onclick="clearSQL2()">
                                <i class="fas fa-eraser"></i> 清除
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 查詢結果 -->
                <div id="queryResults2" style="display: none;">
                    <!-- SQL 轉換結果 -->
                    <div id="sqlConversionCard2" class="card mb-3" style="display: none;">
                        <div class="card-header bg-info text-white">
                            <h6><i class="fas fa-magic"></i> 🔄 SQL 轉換結果</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-comments text-primary"></i> 自然語言查詢：</h6>
                                    <div class="alert alert-light" id="naturalQueryText2"></div>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="fas fa-code text-success"></i> 轉換後的 SQL：</h6>
                                    <div class="alert alert-success" id="generatedSQLText2"></div>
                                </div>
                            </div>
                            <div class="text-center mt-2">
                                <button class="btn btn-sm btn-outline-info" onclick="copyToClipboard2('generatedSQLText2')">
                                    <i class="fas fa-copy"></i> 複製 SQL
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 查詢結果表格 -->
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h6><i class="fas fa-table"></i> 📊 查詢結果</h6>
                            <small id="queryInfo2"></small>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="queryTable2">
                                    <thead id="queryTableHead2">
                                    </thead>
                                    <tbody id="queryTableBody2">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 預測Agent頁面 -->
        <div id="forecast-agent" class="page-content">
            <div class="main-container">
                <div class="text-center mb-4">
                    <h1><i class="fas fa-chart-line text-primary"></i> 預測Agent</h1>
                    <p class="text-muted">AI驅動的銷售預測分析系統</p>
                </div>

                <!-- 預測選項卡片 -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card shadow-lg h-100">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i class="fas fa-bolt fa-3x text-warning"></i>
                                </div>
                                <h4 class="card-title">立即執行預測</h4>
                                <p class="card-text">立即執行銷售預測分析，獲取最新的預測結果和圖表。</p>
                                <button class="btn btn-warning btn-lg" onclick="window.open('/unified-forecast-test', '_blank')">
                                    <i class="fas fa-play"></i> 立即執行
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card shadow-lg h-100">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i class="fas fa-calendar-alt fa-3x text-info"></i>
                                </div>
                                <h4 class="card-title">定期預測設定</h4>
                                <p class="card-text">設定定期自動執行預測，每月自動生成預測報告。</p>
                                <button class="btn btn-info btn-lg" onclick="showScheduleModal()">
                                    <i class="fas fa-cog"></i> 設定排程
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 預測結果區域 -->
                <div id="forecastResults" style="display: none;">
                    <div class="card shadow-lg">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="fas fa-chart-bar"></i> 預測結果</h5>
                        </div>
                        <div class="card-body">
                            <div id="forecastLoading" class="text-center" style="display: none;">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">載入中...</span>
                                </div>
                                <p class="mt-2">正在執行預測分析，請稍候...</p>
                            </div>
                            <div id="forecastContent">
                                <!-- 預測結果將在這裡顯示 -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 歷史預測記錄 -->
                <div class="card shadow-lg mt-4">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0"><i class="fas fa-history"></i> 歷史預測記錄</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>執行時間</th>
                                        <th>預測類型</th>
                                        <th>預測期數</th>
                                        <th>總預測銷售額</th>
                                        <th>平均銷售額</th>
                                        <th>狀態</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="forecastHistory">
                                    <!-- 歷史記錄將在這裡顯示 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 定期預測設定模態框 -->
        <div class="modal fade" id="scheduleModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-calendar-alt"></i> 定期預測設定</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="scheduleForm">
                            <div class="mb-3">
                                <label for="scheduleType" class="form-label">執行頻率</label>
                                <select class="form-select" id="scheduleType">
                                    <option value="monthly">每月執行</option>
                                    <option value="weekly">每週執行</option>
                                    <option value="daily">每日執行</option>
                                </select>
                            </div>
                            <div class="mb-3" id="monthlyOptions">
                                <label for="monthlyDay" class="form-label">每月執行日期</label>
                                <select class="form-select" id="monthlyDay">
                                    <option value="1">1號</option>
                                    <option value="2">2號</option>
                                    <option value="3">3號</option>
                                    <option value="4">4號</option>
                                    <option value="5">5號</option>
                                    <option value="6">6號</option>
                                    <option value="7">7號</option>
                                    <option value="8">8號</option>
                                    <option value="9">9號</option>
                                    <option value="10">10號</option>
                                    <option value="11">11號</option>
                                    <option value="12">12號</option>
                                    <option value="13">13號</option>
                                    <option value="14">14號</option>
                                    <option value="15">15號</option>
                                    <option value="16">16號</option>
                                    <option value="17">17號</option>
                                    <option value="18">18號</option>
                                    <option value="19">19號</option>
                                    <option value="20">20號</option>
                                    <option value="21">21號</option>
                                    <option value="22">22號</option>
                                    <option value="23">23號</option>
                                    <option value="24">24號</option>
                                    <option value="25">25號</option>
                                    <option value="26">26號</option>
                                    <option value="27">27號</option>
                                    <option value="28">28號</option>
                                    <option value="29">29號</option>
                                    <option value="30">30號</option>
                                    <option value="31">31號</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="forecastPeriods" class="form-label">預測期數</label>
                                <select class="form-select" id="forecastPeriods">
                                    <option value="6">6個月</option>
                                    <option value="12" selected>12個月</option>
                                    <option value="18">18個月</option>
                                    <option value="24">24個月</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="forecastMethod" class="form-label">預測方法</label>
                                <select class="form-select" id="forecastMethod">
                                    <option value="sarimax" selected>SARIMAX</option>
                                    <option value="simple">簡單移動平均</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="executionTime" class="form-label">執行時間</label>
                                <input type="time" class="form-control" id="executionTime" value="08:00">
                                <div class="form-text">設定每日/週/月執行的具體時間</div>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="emailNotification" checked>
                                <label class="form-check-label" for="emailNotification">
                                    執行完成後發送郵件通知
                                </label>
                            </div>
                            <div class="mb-3" id="emailSettings" style="display: block;">
                                <label for="emailRecipients" class="form-label">郵件收件人</label>
                                <input type="email" class="form-control" id="emailRecipients" placeholder="example@company.com" value="">
                                <div class="form-text">可輸入多個郵件地址，用逗號分隔</div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" onclick="saveSchedule()">儲存設定</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 公告頁面 -->
        <div id="announcement" class="page-content">
            <div class="main-container">
                <div class="text-center mb-4">
                    <h1><i class="fas fa-bullhorn text-primary"></i> 公告中心</h1>
                    <p class="text-muted">重要公告與系統更新資訊</p>
                </div>

                <!-- 公告分類標籤 -->
                <div class="mb-4">
                    <div class="btn-group" role="group" aria-label="公告分類">
                        <button type="button" class="btn btn-outline-primary active" onclick="filterAnnouncements('all')">
                            <i class="fas fa-list"></i> 全部公告
                        </button>
                        <button type="button" class="btn btn-outline-success" onclick="filterAnnouncements('system')">
                            <i class="fas fa-cog"></i> 系統更新
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="filterAnnouncements('feature')">
                            <i class="fas fa-star"></i> 功能發布
                        </button>
                        <button type="button" class="btn btn-outline-warning" onclick="filterAnnouncements('maintenance')">
                            <i class="fas fa-tools"></i> 維護通知
                        </button>
                        <button type="button" class="btn btn-outline-danger" onclick="filterAnnouncements('urgent')">
                            <i class="fas fa-exclamation-triangle"></i> 緊急通知
                        </button>
                    </div>
                </div>

                <!-- 公告列表 -->
                <div id="announcementList">
                    <!-- 緊急通知 -->
                    <div class="announcement-card urgent" data-category="urgent">
                        <div class="card border-danger mb-3">
                            <div class="card-header bg-danger text-white">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">
                                        <i class="fas fa-exclamation-triangle"></i> 緊急通知
                                    </h6>
                                    <span class="badge bg-light text-danger">緊急</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <h5 class="card-title">系統安全更新 - 重要安全修補</h5>
                                <p class="card-text">
                                    為確保系統安全性，我們將於 <strong>2025年7月15日 凌晨2:00-4:00</strong> 進行重要的安全更新。
                                    更新期間系統將暫停服務，請提前做好相關準備。
                                </p>
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-clock text-warning"></i> 更新時間</h6>
                                        <p class="text-muted">2025年7月15日 02:00-04:00</p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-shield-alt text-success"></i> 影響範圍</h6>
                                        <p class="text-muted">所有用戶服務暫停</p>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <span class="badge bg-secondary">2025-07-11</span>
                                    <span class="badge bg-danger">高優先級</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 功能發布 -->
                    <div class="announcement-card feature" data-category="feature">
                        <div class="card border-info mb-3">
                            <div class="card-header bg-info text-white">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">
                                        <i class="fas fa-star"></i> 功能發布
                                    </h6>
                                    <span class="badge bg-light text-info">新功能</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <h5 class="card-title">🎉 自然語言查詢功能正式上線</h5>
                                <p class="card-text">
                                    我們很高興地宣布，NL2Cube 智慧分析系統的自然語言查詢功能已經正式上線！
                                    現在您可以使用中文自然語言來查詢資料庫，系統會自動轉換為SQL並執行查詢。
                                </p>
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-magic text-primary"></i> 新功能特色</h6>
                                        <ul class="list-unstyled">
                                            <li><i class="fas fa-check text-success"></i> 中文自然語言查詢</li>
                                            <li><i class="fas fa-check text-success"></i> 自動SQL轉換</li>
                                            <li><i class="fas fa-check text-success"></i> 查詢結果視覺化</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-lightbulb text-warning"></i> 使用範例</h6>
                                        <ul class="list-unstyled">
                                            <li><i class="fas fa-arrow-right text-info"></i> "顯示所有產品"</li>
                                            <li><i class="fas fa-arrow-right text-info"></i> "查詢客戶銷售額"</li>
                                            <li><i class="fas fa-arrow-right text-info"></i> "統計各產品銷售額"</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <span class="badge bg-secondary">2025-07-10</span>
                                    <span class="badge bg-info">功能發布</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 系統更新 -->
                    <div class="announcement-card system" data-category="system">
                        <div class="card border-success mb-3">
                            <div class="card-header bg-success text-white">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">
                                        <i class="fas fa-cog"></i> 系統更新
                                    </h6>
                                    <span class="badge bg-light text-success">更新</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <h5 class="card-title">📊 資料庫查詢工具升級完成</h5>
                                <p class="card-text">
                                    我們已完成資料庫查詢工具的升級，新增了更多實用功能，提升您的查詢體驗。
                                </p>
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-plus text-success"></i> 新增功能</h6>
                                        <ul class="list-unstyled">
                                            <li><i class="fas fa-check text-success"></i> SQL轉換結果顯示</li>
                                            <li><i class="fas fa-check text-success"></i> 一鍵複製SQL功能</li>
                                            <li><i class="fas fa-check text-success"></i> 查詢範例按鈕</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-wrench text-warning"></i> 效能優化</h6>
                                        <ul class="list-unstyled">
                                            <li><i class="fas fa-check text-success"></i> 查詢響應速度提升30%</li>
                                            <li><i class="fas fa-check text-success"></i> 錯誤處理機制改善</li>
                                            <li><i class="fas fa-check text-success"></i> 使用者介面優化</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <span class="badge bg-secondary">2025-07-08</span>
                                    <span class="badge bg-success">系統更新</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 維護通知 -->
                    <div class="announcement-card maintenance" data-category="maintenance">
                        <div class="card border-warning mb-3">
                            <div class="card-header bg-warning text-dark">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">
                                        <i class="fas fa-tools"></i> 維護通知
                                    </h6>
                                    <span class="badge bg-light text-warning">維護</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <h5 class="card-title">🔧 定期系統維護通知</h5>
                                <p class="card-text">
                                    為確保系統穩定運行，我們將於每週日凌晨進行例行性系統維護。
                                    維護期間部分功能可能暫時無法使用，敬請見諒。
                                </p>
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-calendar text-info"></i> 維護時間</h6>
                                        <p class="text-muted">每週日 01:00-03:00</p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-info-circle text-primary"></i> 影響範圍</h6>
                                        <p class="text-muted">部分查詢功能可能延遲</p>
                                    </div>
                                </div>
                                <div class="alert alert-info mt-3">
                                    <i class="fas fa-info-circle"></i>
                                    <strong>提醒：</strong> 建議在維護時間前完成重要查詢工作，避免資料遺失。
                                </div>
                                <div class="mt-3">
                                    <span class="badge bg-secondary">2025-07-05</span>
                                    <span class="badge bg-warning">定期維護</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 功能發布 -->
                    <div class="announcement-card feature" data-category="feature">
                        <div class="card border-info mb-3">
                            <div class="card-header bg-info text-white">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">
                                        <i class="fas fa-star"></i> 功能發布
                                    </h6>
                                    <span class="badge bg-light text-info">新功能</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <h5 class="card-title">📈 Drill Down 分析功能上線</h5>
                                <p class="card-text">
                                    全新的 Drill Down 分析功能現已上線！現在您可以對分析結果進行更深入的探索，
                                    發現隱藏在數據背後的洞察。
                                </p>
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-search-plus text-primary"></i> 功能特色</h6>
                                        <ul class="list-unstyled">
                                            <li><i class="fas fa-check text-success"></i> 多維度下鑽分析</li>
                                            <li><i class="fas fa-check text-success"></i> 動態維度選擇</li>
                                            <li><i class="fas fa-check text-success"></i> 即時結果更新</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-chart-line text-success"></i> 使用方式</h6>
                                        <ul class="list-unstyled">
                                            <li><i class="fas fa-arrow-right text-info"></i> 執行智慧分析查詢</li>
                                            <li><i class="fas fa-arrow-right text-info"></i> 點擊「Drill Down」按鈕</li>
                                            <li><i class="fas fa-arrow-right text-info"></i> 選擇下鑽維度</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <span class="badge bg-secondary">2025-07-03</span>
                                    <span class="badge bg-info">功能發布</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 系統更新 -->
                    <div class="announcement-card system" data-category="system">
                        <div class="card border-success mb-3">
                            <div class="card-header bg-success text-white">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">
                                        <i class="fas fa-cog"></i> 系統更新
                                    </h6>
                                    <span class="badge bg-light text-success">更新</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <h5 class="card-title">🎨 使用者介面全面升級</h5>
                                <p class="card-text">
                                    我們對整個系統的使用者介面進行了全面升級，提供更現代化、更直觀的操作體驗。
                                </p>
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-palette text-primary"></i> 視覺改進</h6>
                                        <ul class="list-unstyled">
                                            <li><i class="fas fa-check text-success"></i> 現代化設計風格</li>
                                            <li><i class="fas fa-check text-success"></i> 響應式佈局</li>
                                            <li><i class="fas fa-check text-success"></i> 動畫效果優化</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-mobile-alt text-info"></i> 行動裝置支援</h6>
                                        <ul class="list-unstyled">
                                            <li><i class="fas fa-check text-success"></i> 手機版優化</li>
                                            <li><i class="fas fa-check text-success"></i> 平板裝置支援</li>
                                            <li><i class="fas fa-check text-success"></i> 觸控操作優化</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <span class="badge bg-secondary">2025-07-01</span>
                                    <span class="badge bg-success">系統更新</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 公告統計 -->
                <div class="card mt-4">
                    <div class="card-header bg-light">
                        <h6><i class="fas fa-chart-bar"></i> 公告統計</h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-2">
                                <div class="stat-item">
                                    <h4 class="text-primary">6</h4>
                                    <small class="text-muted">總公告數</small>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="stat-item">
                                    <h4 class="text-danger">1</h4>
                                    <small class="text-muted">緊急通知</small>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="stat-item">
                                    <h4 class="text-info">2</h4>
                                    <small class="text-muted">功能發布</small>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="stat-item">
                                    <h4 class="text-success">2</h4>
                                    <small class="text-muted">系統更新</small>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="stat-item">
                                    <h4 class="text-warning">1</h4>
                                    <small class="text-muted">維護通知</small>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="stat-item">
                                    <h4 class="text-secondary">7月</h4>
                                    <small class="text-muted">本月更新</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let chart = null;

        // 範例按鈕點擊處理
        document.addEventListener('DOMContentLoaded', function() {
            // 為所有範例按鈕添加點擊事件
            document.querySelectorAll('.example-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const query = this.getAttribute('data-query');
                    document.getElementById('queryInput').value = query;
                    
                    // 添加視覺反饋
                    this.classList.add('btn-primary');
                    this.classList.remove('btn-outline-primary', 'btn-outline-success', 'btn-outline-info', 'btn-outline-warning', 'btn-outline-danger', 'btn-outline-secondary');
                    
                    // 重置其他按鈕樣式
                    document.querySelectorAll('.example-btn').forEach(otherBtn => {
                        if (otherBtn !== this) {
                            otherBtn.classList.remove('btn-primary');
                            // 恢復原始樣式
                            const originalClass = otherBtn.getAttribute('data-original-class') || 'btn-outline-primary';
                            otherBtn.className = otherBtn.className.replace(/btn-\w+/, originalClass);
                        }
                    });
                    
                    // 儲存原始樣式
                    this.setAttribute('data-original-class', this.className.match(/btn-outline-\w+/)[0]);
                });
            });
        });

        // 頁面切換功能
        function showPage(pageId) {
            // 隱藏所有頁面
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.remove('active');
            });
            
            // 顯示選中的頁面
            document.getElementById(pageId).classList.add('active');
            
            // 更新導航連結狀態
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // 找到對應的導航連結並設為活動狀態
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                if (link.getAttribute('onclick') && link.getAttribute('onclick').includes(pageId)) {
                    link.classList.add('active');
                }
            });
            
            // 公司介紹頁面不再自動跳轉到外部網站
            // 如果需要跳轉功能，可以取消註解下面的程式碼
            /*
            if (pageId === 'company') {
                setTimeout(() => {
                    window.open('https://www.nutn.edu.tw/about.html', '_blank');
                }, 1500); // 1.5秒後自動跳轉
            }
            */
            // 所有頁面都正常顯示，不執行跳轉
        }

        // 查詢表單處理
        document.getElementById('queryForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const query = document.getElementById('queryInput').value.trim();
            if (!query) {
                alert('請輸入查詢內容');
                return;
            }

            // 顯示載入中
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query: query })
                });

                const result = await response.json();

                if (response.ok) {
                    // 保存分析結果供 drill down 使用
                    window.currentAnalysisResult = result;
                    displayResults(result);
                } else {
                    alert('錯誤: ' + result.error);
                }
            } catch (error) {
                alert('發生錯誤: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        });

        // 預測Agent相關函數
        function executeForecast() {
            // 顯示載入中
            document.getElementById('forecastResults').style.display = 'block';
            document.getElementById('forecastLoading').style.display = 'block';
            document.getElementById('forecastContent').innerHTML = '';

            // 發送預測請求
            fetch('/forecast', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'execute',
                    periods: 12,
                    method: 'sarimax'
                })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('forecastLoading').style.display = 'none';
                if (data.success) {
                    displayForecastResults(data);
                    addToForecastHistory(data);
                } else {
                    document.getElementById('forecastContent').innerHTML = 
                        `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> 預測執行失敗: ${data.error}</div>`;
                }
            })
            .catch(error => {
                document.getElementById('forecastLoading').style.display = 'none';
                document.getElementById('forecastContent').innerHTML = 
                    `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> 發生錯誤: ${error.message}</div>`;
            });
        }

        function displayForecastResults(data) {
            console.log('顯示預測結果:', data);
            
            // 安全檢查：確保 data 和必要屬性存在
            if (!data || typeof data !== 'object') {
                console.error('預測結果數據無效:', data);
                return;
            }
            
            const content = document.getElementById('forecastContent');
            let html = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="fas fa-chart-line"></i> 預測摘要</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-6">
                                        <h4 class="text-primary">${formatNumber(data.total_forecast)}</h4>
                                        <small class="text-muted">總預測銷售額 (元)</small>
                                    </div>
                                    <div class="col-6">
                                        <h4 class="text-success">${formatNumber(data.avg_forecast)}</h4>
                                        <small class="text-muted">平均銷售額 (元)</small>
                                    </div>
                                </div>
                                <hr>
                                <div class="row">
                                    <div class="col-6">
                                        <h6>預測期數</h6>
                                        <p class="text-muted">${data.periods} 個月</p>
                                    </div>
                                    <div class="col-6">
                                        <h6>預測方法</h6>
                                        <p class="text-muted">${data.method}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0"><i class="fas fa-list"></i> 詳細預測</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>期間</th>
                                                <th>預測銷售額</th>
                                            </tr>
                                        </thead>
                                        <tbody>
            `;
            
            if (data.forecast_data && Array.isArray(data.forecast_data)) {
                data.forecast_data.forEach(item => {
                    html += `
                        <tr>
                            <td>${item.period || 'N/A'}</td>
                            <td>${formatNumber(item.forecast_sales || 0)} 元</td>
                        </tr>
                    `;
                });
            } else {
                html += `
                    <tr>
                        <td colspan="2" class="text-center text-muted">暫無預測數據</td>
                    </tr>
                `;
            }
            
            html += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            if (data.chart_filename) {
                html += `
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-warning text-white">
                                    <h6 class="mb-0"><i class="fas fa-chart-area"></i> 預測圖表</h6>
                                </div>
                                <div class="card-body text-center">
                                    <img src="/static/${data.chart_filename}" class="img-fluid" alt="預測圖表" onerror="this.style.display='none'; this.parentElement.innerHTML='<p class=\'text-muted\'>圖表載入失敗</p>';">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // 顯示資深經營分析專家報告
            if (data.advanced_analysis && data.advanced_analysis !== "進階分析結果載入中..." && data.advanced_analysis.length > 10) {
                html += `
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0"><i class="fas fa-user-tie"></i> 資深經營分析專家報告</h6>
                                </div>
                                <div class="card-body">
                                    <div class="report-content">
                                        <div style="white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.6; max-height: 600px; overflow-y: auto; background-color: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6;">
                                            ${data.advanced_analysis}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // 顯示摘要結果
            if (data.summary_result && data.summary_result !== "摘要結果載入中..." && data.summary_result.length > 10) {
                html += `
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0"><i class="fas fa-list-check"></i> 關鍵摘要</h6>
                                </div>
                                <div class="card-body">
                                    <div style="white-space: pre-wrap; font-size: 14px; line-height: 1.6; background-color: #d4edda; padding: 15px; border-radius: 8px; border: 1px solid #c3e6cb;">
                                        ${data.summary_result}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // 顯示詳細分析結果
            if (data.analysis_result && data.analysis_result !== "分析結果載入中..." && data.analysis_result.length > 10) {
                html += `
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0"><i class="fas fa-chart-line"></i> 詳細分析</h6>
                                </div>
                                <div class="card-body">
                                    <div style="white-space: pre-wrap; font-size: 14px; line-height: 1.6; max-height: 400px; overflow-y: auto; background-color: #d1ecf1; padding: 15px; border-radius: 8px; border: 1px solid #bee5eb;">
                                        ${data.analysis_result}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // 添加調試信息
            console.log('分析結果檢查:');
            console.log('advanced_analysis:', data.advanced_analysis ? data.advanced_analysis.substring(0, 100) + '...' : 'null');
            console.log('summary_result:', data.summary_result ? data.summary_result.substring(0, 100) + '...' : 'null');
            console.log('analysis_result:', data.analysis_result ? data.analysis_result.substring(0, 100) + '...' : 'null');
            
            content.innerHTML = html;
        }

        function addToForecastHistory(data) {
            const tbody = document.getElementById('forecastHistory');
            const now = new Date().toLocaleString('zh-TW');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${now}</td>
                <td>${data.forecast_type}</td>
                <td>${data.periods} 個月</td>
                <td>${formatNumber(data.total_forecast)} 元</td>
                <td>${formatNumber(data.avg_forecast)} 元</td>
                <td><span class="badge bg-success">完成</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="viewForecastDetails('${data.chart_filename}')">
                        <i class="fas fa-eye"></i> 查看
                    </button>
                </td>
            `;
            tbody.insertBefore(row, tbody.firstChild);
        }

        function showScheduleModal() {
            const modal = new bootstrap.Modal(document.getElementById('scheduleModal'));
            modal.show();
        }

        function saveSchedule() {
            const scheduleType = document.getElementById('scheduleType').value;
            const monthlyDay = document.getElementById('monthlyDay').value;
            const forecastPeriods = document.getElementById('forecastPeriods').value;
            const forecastMethod = document.getElementById('forecastMethod').value;
            const executionTime = document.getElementById('executionTime').value;
            const emailNotification = document.getElementById('emailNotification').checked;
            const emailRecipients = document.getElementById('emailRecipients').value;

            // 驗證郵件地址
            if (emailNotification && !emailRecipients.trim()) {
                alert('請輸入郵件收件人地址');
                return;
            }

            // 發送設定到後端
            fetch('/forecast', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'schedule',
                    schedule_type: scheduleType,
                    monthly_day: monthlyDay,
                    forecast_periods: forecastPeriods,
                    forecast_method: forecastMethod,
                    execution_time: executionTime,
                    email_notification: emailNotification,
                    email_recipients: emailRecipients
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('定期預測設定已儲存！');
                    bootstrap.Modal.getInstance(document.getElementById('scheduleModal')).hide();
                } else {
                    alert('設定失敗: ' + data.error);
                }
            })
            .catch(error => {
                alert('發生錯誤: ' + error.message);
            });
        }

        // 郵件通知開關控制
        document.getElementById('emailNotification').addEventListener('change', function() {
            const emailSettings = document.getElementById('emailSettings');
            if (this.checked) {
                emailSettings.style.display = 'block';
            } else {
                emailSettings.style.display = 'none';
            }
        });

        function viewForecastDetails(chartFilename) {
            // 可以實作查看詳細預測結果的功能
            window.open(`/static/${chartFilename}`, '_blank');
        }

        // 將原本 displayResults 內容抽出
        function originalDisplayResults(data) {
            // 顯示分析總結（添加安全檢查）
            const summaryElement = document.getElementById('summary');
            if (data.summary && typeof data.summary === 'string' && data.summary.trim() !== '') {
                summaryElement.innerHTML = data.summary;
                
                // 顯示語音播放控制區域
                showVoiceControlSection();
            } else {
                // 生成預設摘要報告
                const defaultSummary = generateDefaultSummary(data);
                summaryElement.innerHTML = defaultSummary;
                
                // 顯示語音播放控制區域
                showVoiceControlSection();
            }

            // 顯示關鍵指標
            document.getElementById('currentSales').textContent = formatNumber(data.current_sales) + ' 元';
            document.getElementById('lastSales').textContent = formatNumber(data.last_sales) + ' 元';
            document.getElementById('diff').textContent = formatNumber(data.diff) + ' 元';
            
            const percentageElement = document.getElementById('percentageDiff');
            if (data.percentage_diff !== undefined && data.percentage_diff !== Infinity && data.percentage_diff !== -Infinity) {
                percentageElement.textContent = (data.diff >= 0 ? '+' : '') + data.percentage_diff.toFixed(2) + '%';
                percentageElement.className = data.diff >= 0 ? 'positive' : 'negative';
            } else {
                percentageElement.textContent = 'N/A';
                percentageElement.className = 'neutral';
            }

            // 顯示貢獻度排行
            const tableBody = document.getElementById('driverTableBody');
            tableBody.innerHTML = '';
            
            if (data.driver_data && Array.isArray(data.driver_data)) {
                data.driver_data.forEach((row, index) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${row['分析維度'] || 'N/A'}</td>
                        <td>${formatNumber(row['本期銷售額'] || 0)}</td>
                        <td>${formatNumber(row['前期銷售額'] || 0)}</td>
                        <td class="${(row['差異'] || 0) >= 0 ? 'positive' : 'negative'}" style="${(row['差異'] || 0) < 0 ? 'color:#dc3545;font-weight:bold;' : ''}">${formatNumber(row['差異'] || 0)}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary drill-down-btn" 
                                    data-index="${index}" 
                                    data-value="${row['分析維度'] || 'N/A'}"
                                    data-current-sales="${row['本期銷售額'] || 0}"
                                    data-last-sales="${row['前期銷售額'] || 0}"
                                    data-diff="${row['差異'] || 0}">
                                <i class="fas fa-search-plus"></i> Drill Down
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });
            } else {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">暫無貢獻度數據</td></tr>';
            }

            // 顯示 Drill Down 維度選擇
            if (data.available_dimensions && Object.keys(data.available_dimensions).length > 0) {
                displayDrillDownOptions(data.available_dimensions, data.current_dimension);
            }

            // 創建圖表類型選擇器
            createChartTypeSelector();
            
            // 更新圖表（添加安全檢查）
            if (data.driver_data && Array.isArray(data.driver_data) && data.driver_data.length > 0) {
                updateChart(data.driver_data, data.dimension_text);
            } else {
                console.warn('圖表數據無效或為空:', data.driver_data);
                // 清空圖表區域
                const chartContainer = document.getElementById('chartContainer');
                if (chartContainer) {
                    chartContainer.innerHTML = '<div class="text-center text-muted p-4">暫無圖表數據</div>';
                }
            }

            // 顯示結果
            document.getElementById('results').style.display = 'block';
            
            // 隱藏 Drill Down 結果
            document.getElementById('drillDownResults').style.display = 'none';
        }

        // 新的 displayResults 呼叫原始函數並加上聊天上下文
        function displayResults(data) {
            // 安全檢查：確保數據有效
            if (!data || typeof data !== 'object') {
                console.error('顯示結果數據無效:', data);
                return;
            }
            
            originalDisplayResults(data);
            
            // 設置聊天上下文（添加安全檢查）
            currentAnalysisContext = {
                period_text: data.period_text || '',
                current_sales: data.current_sales || 0,
                last_sales: data.last_sales || 0,
                diff: data.diff || 0,
                percentage_diff: data.percentage_diff || 0,
                dimension_text: data.dimension_text || '',
                summary: data.summary || '',
                driver_data: data.driver_data || [],
                other_dimension_reference: data.other_dimension_reference || ''
            };
            
            // 清空聊天歷史
            chatHistory = [];
        }

        function displayDrillDownOptions(availableDimensions, currentDimension) {
            const drillDownSection = document.getElementById('drillDownSection');
            const drillDownOptions = document.getElementById('drillDownOptions');
            
            drillDownOptions.innerHTML = '';
            
            Object.entries(availableDimensions).forEach(([key, value]) => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-outline-info btn-sm';
                btn.textContent = value;
                btn.onclick = () => selectDrillDownDimension(key, value);
                drillDownOptions.appendChild(btn);
            });
            
            drillDownSection.style.display = 'block';
        }

        function selectDrillDownDimension(dimensionKey, dimensionText) {
            // 儲存選擇的 drill down 維度
            window.selectedDrillDownDimension = { key: dimensionKey, text: dimensionText };
            
            // 更新按鈕樣式
            document.querySelectorAll('#drillDownOptions button').forEach(btn => {
                btn.classList.remove('btn-info');
                btn.classList.add('btn-outline-info');
            });
            
            event.target.classList.remove('btn-outline-info');
            event.target.classList.add('btn-info');
        }

        // Drill Down 按鈕點擊事件
        document.addEventListener('click', function(e) {
            if (e.target.closest('.drill-down-btn')) {
                const btn = e.target.closest('.drill-down-btn');
                const primaryValue = btn.getAttribute('data-value');
                const currentSales = parseFloat(btn.getAttribute('data-current-sales'));
                const lastSales = parseFloat(btn.getAttribute('data-last-sales'));
                const diff = parseFloat(btn.getAttribute('data-diff'));
                
                // 檢查是否已選擇 drill down 維度
                if (!window.selectedDrillDownDimension) {
                    alert('請先選擇要下鑽分析的維度');
                    return;
                }
                
                // 執行 drill down 分析
                performDrillDownAnalysis(primaryValue, window.selectedDrillDownDimension.key);
            }
        });

        async function performDrillDownAnalysis(primaryValue, drillDimension) {
            // 顯示載入中
            document.getElementById('loading').style.display = 'block';
            
            try {
                // 從當前分析結果中獲取時間參數
                const currentAnalysis = window.currentAnalysisResult;
                if (!currentAnalysis) {
                    alert('無法獲取當前分析參數');
                    return;
                }
                
                const response = await fetch('/drill-down', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        current_start: currentAnalysis.current_start,
                        current_end: currentAnalysis.current_end,
                        last_start: currentAnalysis.last_start,
                        last_end: currentAnalysis.last_end,
                        primary_dimension: currentAnalysis.current_dimension,
                        primary_value: primaryValue,
                        drill_dimension: drillDimension
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    displayDrillDownResults(result, primaryValue);
                } else {
                    alert('錯誤: ' + result.error);
                }
            } catch (error) {
                alert('發生錯誤: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function displayDrillDownResults(data, primaryValue) {
            // 顯示 Drill Down 上下文
            document.getElementById('drillDownContext').textContent = 
                `針對 ${data.primary_dimension_text}【${primaryValue}】的 ${data.drill_dimension_text} 下鑽分析`;
            
            // 顯示 Drill Down 數據
            const tableBody = document.getElementById('drillDownTableBody');
            tableBody.innerHTML = '';
            
            if (data.drill_down_data && Array.isArray(data.drill_down_data)) {
                data.drill_down_data.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${row['下鑽維度'] || 'N/A'}</td>
                        <td>${formatNumber(row['本期銷售額'] || 0)}</td>
                        <td>${formatNumber(row['前期銷售額'] || 0)}</td>
                        <td class="${(row['差異'] || 0) >= 0 ? 'positive' : 'negative'}">${formatNumber(row['差異'] || 0)}</td>
                    `;
                    tableBody.appendChild(tr);
                });
            } else {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">暫無下鑽數據</td></tr>';
            }
            
            // 顯示 Drill Down 結果
            document.getElementById('drillDownResults').style.display = 'block';
        }

        // --- SQLite Viewer 功能 ---
        let currentPage = 1;
        let currentTable = '';
        let totalPages = 1;

        // 頁面載入時初始化資料庫資訊
        document.addEventListener('DOMContentLoaded', function() {
            loadDatabaseInfo();
        });

        async function loadDatabaseInfo() {
            try {
                const response = await fetch('/db/tables');
                const result = await response.json();
                
                if (response.ok) {
                    const tableSelect = document.getElementById('tableSelect');
                    const tableCount = document.getElementById('tableCount');
                    
                    // 更新資料表數量
                    tableCount.textContent = result.tables.length;
                    
                    // 填充資料表選擇下拉選單
                    tableSelect.innerHTML = '<option value="">請選擇資料表...</option>';
                    if (result.tables && Array.isArray(result.tables)) {
                        result.tables.forEach(table => {
                            const option = document.createElement('option');
                            option.value = table;
                            option.textContent = table;
                            tableSelect.appendChild(option);
                        });
                    } else {
                        console.warn('資料表列表為空或格式錯誤');
                    }
                } else {
                    console.error('載入資料庫資訊失敗:', result.error);
                }
            } catch (error) {
                console.error('載入資料庫資訊時發生錯誤:', error);
            }
        }

        async function loadTableData() {
            const tableName = document.getElementById('tableSelect').value;
            if (!tableName) {
                alert('請先選擇資料表');
                return;
            }
            
            currentTable = tableName;
            currentPage = 1;
            await fetchTableData();
        }

        async function fetchTableData() {
            try {
                const response = await fetch(`/db/data/${currentTable}?page=${currentPage}&limit=10`);
                const result = await response.json();
                
                if (response.ok) {
                    displayTableData(result);
                } else {
                    alert('載入資料失敗: ' + result.error);
                }
            } catch (error) {
                alert('載入資料時發生錯誤: ' + error.message);
            }
        }

        function displayTableData(result) {
            const dataCard = document.getElementById('dataCard');
            const dataInfo = document.getElementById('dataInfo');
            const dataTableHead = document.getElementById('dataTableHead');
            const dataTableBody = document.getElementById('dataTableBody');
            const paginationInfo = document.getElementById('paginationInfo');
            
            // 檢查結果是否有效
            if (!result || typeof result !== 'object') {
                alert('無效的數據格式');
                return;
            }
            
            // 更新資訊
            dataInfo.textContent = `資料表: ${currentTable} | 總記錄數: ${result.total_count || 0}`;
            
            // 更新分頁資訊
            totalPages = result.total_pages || 1;
            const start = ((result.current_page || 1) - 1) * (result.limit || 10) + 1;
            const end = Math.min((result.current_page || 1) * (result.limit || 10), result.total_count || 0);
            paginationInfo.textContent = `顯示 ${start}-${end} 筆，共 ${result.total_count || 0} 筆`;
            
            // 檢查並更新表格標題
            dataTableHead.innerHTML = '';
            const headerRow = document.createElement('tr');
            
            if (result.columns && Array.isArray(result.columns)) {
                result.columns.forEach(column => {
                    const th = document.createElement('th');
                    th.textContent = column;
                    headerRow.appendChild(th);
                });
            } else {
                // 如果沒有 columns，嘗試從數據中推斷
                if (result.data && result.data.length > 0) {
                    const firstRow = result.data[0];
                    Object.keys(firstRow).forEach(key => {
                        const th = document.createElement('th');
                        th.textContent = key;
                        headerRow.appendChild(th);
                    });
                }
            }
            dataTableHead.appendChild(headerRow);
            
            // 檢查並更新表格數據
            dataTableBody.innerHTML = '';
            if (result.data && Array.isArray(result.data)) {
                result.data.forEach(row => {
                    const tr = document.createElement('tr');
                    const columns = result.columns || (result.data.length > 0 ? Object.keys(result.data[0]) : []);
                    columns.forEach(column => {
                        const td = document.createElement('td');
                        td.textContent = row[column] !== null && row[column] !== undefined ? row[column] : '';
                        tr.appendChild(td);
                    });
                    dataTableBody.appendChild(tr);
                });
            }
            
            // 更新分頁按鈕
            document.getElementById('prevBtn').disabled = (result.current_page || 1) <= 1;
            document.getElementById('nextBtn').disabled = (result.current_page || 1) >= (result.total_pages || 1);
            
            // 顯示數據卡片
            dataCard.style.display = 'block';
        }

        async function showTableSchema() {
            const tableName = document.getElementById('tableSelect').value;
            if (!tableName) {
                alert('請先選擇資料表');
                return;
            }
            
            try {
                const response = await fetch(`/db/schema/${tableName}`);
                const result = await response.json();
                
                if (response.ok) {
                    displayTableSchema(result.schema);
                } else {
                    alert('載入結構失敗: ' + result.error);
                }
            } catch (error) {
                alert('載入結構時發生錯誤: ' + error.message);
            }
        }

        function displayTableSchema(schema) {
            const schemaCard = document.getElementById('schemaCard');
            const schemaTableBody = document.getElementById('schemaTableBody');
            
            // 檢查 schema 是否有效
            if (!schema || !Array.isArray(schema)) {
                alert('無效的資料表結構');
                return;
            }
            
            schemaTableBody.innerHTML = '';
            schema.forEach(field => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${field.name || ''}</td>
                    <td>${field.type || ''}</td>
                    <td>${field.notnull ? '否' : '是'}</td>
                    <td>${field.default_value || '-'}</td>
                    <td>${field.pk ? '是' : '否'}</td>
                `;
                schemaTableBody.appendChild(tr);
            });
            
            schemaCard.style.display = 'block';
        }

        function exportTableData() {
            const tableName = document.getElementById('tableSelect').value;
            if (!tableName) {
                alert('請先選擇資料表');
                return;
            }
            
            window.open(`/db/export/${tableName}`, '_blank');
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                fetchTableData();
            }
        }

        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                fetchTableData();
            }
        }

        async function executeSQL() {
            const sql = document.getElementById('sqlQuery').value.trim();
            if (!sql) {
                alert('請輸入 SQL 查詢語句');
                return;
            }
            
            try {
                const response = await fetch('/db/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ sql: sql })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    displaySQLResults(result);
                } else {
                    alert('執行查詢失敗: ' + result.error);
                }
            } catch (error) {
                alert('執行查詢時發生錯誤: ' + error.message);
            }
        }

        function displaySQLResults(result) {
            // 使用現有的數據顯示區域來顯示 SQL 查詢結果
            const dataCard = document.getElementById('dataCard');
            const dataInfo = document.getElementById('dataInfo');
            const dataTableHead = document.getElementById('dataTableHead');
            const dataTableBody = document.getElementById('dataTableBody');
            const paginationInfo = document.getElementById('paginationInfo');
            
            // 檢查結果是否有效
            if (!result || typeof result !== 'object') {
                alert('無效的 SQL 查詢結果');
                return;
            }
            
            // 更新資訊
            dataInfo.textContent = `SQL 查詢結果 | 記錄數: ${result.row_count || 0}`;
            
            // 隱藏分頁資訊
            paginationInfo.textContent = '';
            
            // 檢查並更新表格標題
            dataTableHead.innerHTML = '';
            const headerRow = document.createElement('tr');
            
            if (result.columns && Array.isArray(result.columns)) {
                result.columns.forEach(column => {
                    const th = document.createElement('th');
                    th.textContent = column;
                    headerRow.appendChild(th);
                });
            } else {
                // 如果沒有 columns，嘗試從數據中推斷
                if (result.data && result.data.length > 0) {
                    const firstRow = result.data[0];
                    Object.keys(firstRow).forEach(key => {
                        const th = document.createElement('th');
                        th.textContent = key;
                        headerRow.appendChild(th);
                    });
                }
            }
            dataTableHead.appendChild(headerRow);
            
            // 檢查並更新表格數據
            dataTableBody.innerHTML = '';
            if (result.data && Array.isArray(result.data)) {
                result.data.forEach(row => {
                    const tr = document.createElement('tr');
                    const columns = result.columns || (result.data.length > 0 ? Object.keys(result.data[0]) : []);
                    columns.forEach(column => {
                        const td = document.createElement('td');
                        td.textContent = row[column] !== null && row[column] !== undefined ? row[column] : '';
                        tr.appendChild(td);
                    });
                    dataTableBody.appendChild(tr);
                });
            }
            
            // 隱藏分頁按鈕
            document.getElementById('prevBtn').disabled = true;
            document.getElementById('nextBtn').disabled = true;
            
            // 顯示數據卡片
            dataCard.style.display = 'block';
        }

        function clearSQL() {
            document.getElementById('sqlQuery').value = '';
        }

        // 查詢模式切換
        document.addEventListener('DOMContentLoaded', function() {
            // 為查詢模式單選按鈕添加事件監聽
            document.querySelectorAll('input[name="queryMode"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    updateQueryMode();
                });
            });
            
            // 為第二個查詢頁面的模式單選按鈕添加事件監聽
            document.querySelectorAll('input[name="queryMode2"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    updateQueryMode2();
                });
            });
        });

        function updateQueryMode() {
            const sqlMode = document.getElementById('sqlMode');
            const naturalMode = document.getElementById('naturalMode');
            const queryLabel = document.getElementById('queryLabel');
            const sqlQuery = document.getElementById('sqlQuery');
            const naturalExamples = document.getElementById('naturalExamples');
            
            if (naturalMode.checked) {
                // 自然語言模式
                queryLabel.innerHTML = '<i class="fas fa-comments"></i> 自然語言查詢：';
                sqlQuery.placeholder = '輸入自然語言查詢，例如：顯示所有產品、查詢客戶銷售額';
                naturalExamples.style.display = 'block';
            } else {
                // SQL 模式
                queryLabel.innerHTML = '<i class="fas fa-code"></i> SQL 查詢：';
                sqlQuery.placeholder = '輸入 SQL 查詢語句，例如：SELECT * FROM dim_product LIMIT 10';
                naturalExamples.style.display = 'none';
            }
        }

        function setNaturalQuery(query) {
            document.getElementById('sqlQuery').value = query;
        }

        // 第二個查詢頁面的函數
        function updateQueryMode2() {
            const sqlMode = document.getElementById('sqlMode2');
            const naturalMode = document.getElementById('naturalMode2');
            const queryLabel = document.getElementById('queryLabel2');
            const sqlQuery = document.getElementById('sqlQuery2');
            const naturalExamples = document.getElementById('naturalExamples2');
            
            if (naturalMode.checked) {
                // 自然語言模式
                queryLabel.innerHTML = '<i class="fas fa-comments"></i> 自然語言查詢：';
                sqlQuery.placeholder = '輸入自然語言查詢，例如：顯示所有產品、查詢客戶銷售額';
                naturalExamples.style.display = 'block';
            } else {
                // SQL 模式
                queryLabel.innerHTML = '<i class="fas fa-code"></i> SQL 查詢：';
                sqlQuery.placeholder = '輸入 SQL 查詢語句，例如：SELECT * FROM dim_product LIMIT 10';
                naturalExamples.style.display = 'none';
            }
        }

        function setNaturalQuery2(query) {
            document.getElementById('sqlQuery2').value = query;
        }

        async function executeSQL2() {
            const sql = document.getElementById('sqlQuery2').value.trim();
            const isNaturalLanguage = document.getElementById('naturalMode2').checked;
            
            if (!sql) {
                alert('請輸入查詢語句');
                return;
            }
            
            try {
                const response = await fetch('/db/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        sql: sql,
                        is_natural_language: isNaturalLanguage
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    displaySQLResults2(result, isNaturalLanguage);
                } else {
                    alert('執行查詢失敗: ' + result.error);
                }
            } catch (error) {
                alert('執行查詢時發生錯誤: ' + error.message);
            }
        }

        function displaySQLResults2(result, isNaturalLanguage) {
            const queryResults = document.getElementById('queryResults2');
            const queryInfo = document.getElementById('queryInfo2');
            const queryTableHead = document.getElementById('queryTableHead2');
            const queryTableBody = document.getElementById('queryTableBody2');
            const sqlConversionCard = document.getElementById('sqlConversionCard2');
            
            // 更新資訊
            queryInfo.textContent = `查詢結果 | 記錄數: ${result.row_count}`;
            
            // 如果是自然語言查詢且有生成的SQL，顯示SQL轉換區域
            if (isNaturalLanguage && result.generated_sql) {
                document.getElementById('naturalQueryText2').textContent = document.getElementById('sqlQuery2').value;
                document.getElementById('generatedSQLText2').textContent = result.generated_sql;
                sqlConversionCard.style.display = 'block';
            } else {
                sqlConversionCard.style.display = 'none';
            }
            
            // 更新表格標題
            queryTableHead.innerHTML = '';
            const headerRow = document.createElement('tr');
            result.columns.forEach(column => {
                const th = document.createElement('th');
                th.textContent = column;
                headerRow.appendChild(th);
            });
            queryTableHead.appendChild(headerRow);
            
            // 更新表格數據
            queryTableBody.innerHTML = '';
            result.data.forEach(row => {
                const tr = document.createElement('tr');
                result.columns.forEach(column => {
                    const td = document.createElement('td');
                    td.textContent = row[column] !== null ? row[column] : '';
                    tr.appendChild(td);
                });
                queryTableBody.appendChild(tr);
            });
            
            // 顯示查詢結果
            queryResults.style.display = 'block';
        }

        function clearSQL2() {
            document.getElementById('sqlQuery2').value = '';
            document.getElementById('queryResults2').style.display = 'none';
        }

        function copyToClipboard2(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    // 顯示成功提示
                    const button = event.target.closest('button');
                    const originalText = button.innerHTML;
                    button.innerHTML = '<i class="fas fa-check"></i> 已複製';
                    button.classList.remove('btn-outline-info');
                    button.classList.add('btn-success');
                    
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.classList.remove('btn-success');
                        button.classList.add('btn-outline-info');
                    }, 2000);
                }).catch(err => {
                    console.error('複製失敗:', err);
                    alert('複製失敗，請手動複製');
                });
            } else {
                // 降級方案：使用傳統方法
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    alert('已複製到剪貼簿');
                } catch (err) {
                    alert('複製失敗，請手動複製');
                }
                document.body.removeChild(textArea);
            }
        }

        async function executeSQL() {
            const sql = document.getElementById('sqlQuery').value.trim();
            const isNaturalLanguage = document.getElementById('naturalMode').checked;
            
            if (!sql) {
                alert('請輸入查詢語句');
                return;
            }
            
            try {
                const response = await fetch('/db/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        sql: sql,
                        is_natural_language: isNaturalLanguage
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    displaySQLResults(result, isNaturalLanguage);
                } else {
                    alert('執行查詢失敗: ' + result.error);
                }
            } catch (error) {
                alert('執行查詢時發生錯誤: ' + error.message);
            }
        }

        function displaySQLResults(result, isNaturalLanguage) {
            // 使用現有的數據顯示區域來顯示查詢結果
            const dataCard = document.getElementById('dataCard');
            const dataInfo = document.getElementById('dataInfo');
            const dataTableHead = document.getElementById('dataTableHead');
            const dataTableBody = document.getElementById('dataTableBody');
            const paginationInfo = document.getElementById('paginationInfo');
            
            // 更新資訊
            let infoText = `查詢結果 | 記錄數: ${result.row_count}`;
            dataInfo.textContent = infoText;
            
            // 如果是自然語言查詢且有生成的SQL，顯示SQL轉換區域
            if (isNaturalLanguage && result.generated_sql) {
                // 檢查是否已存在SQL轉換顯示區域，如果沒有則創建
                let sqlConversionCard = document.getElementById('sqlConversionCard');
                if (!sqlConversionCard) {
                    // 在數據卡片前插入SQL轉換顯示區域
                    const sqlConversionHTML = `
                        <div class="card mb-3" id="sqlConversionCard">
                            <div class="card-header bg-info text-white">
                                <h6><i class="fas fa-magic"></i> 🔄 SQL 轉換結果</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-comments text-primary"></i> 自然語言查詢：</h6>
                                        <div class="alert alert-light" id="naturalQueryText"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-code text-success"></i> 轉換後的 SQL：</h6>
                                        <div class="alert alert-success" id="generatedSQLText"></div>
                                    </div>
                                </div>
                                <div class="text-center mt-2">
                                    <button class="btn btn-sm btn-outline-info" onclick="copyToClipboard('generatedSQLText')">
                                        <i class="fas fa-copy"></i> 複製 SQL
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    dataCard.insertAdjacentHTML('beforebegin', sqlConversionHTML);
                    sqlConversionCard = document.getElementById('sqlConversionCard');
                }
                
                // 顯示自然語言查詢和生成的SQL
                document.getElementById('naturalQueryText').textContent = document.getElementById('sqlQuery').value;
                document.getElementById('generatedSQLText').textContent = result.generated_sql;
                sqlConversionCard.style.display = 'block';
            } else {
                // 如果不是自然語言查詢，隱藏SQL轉換區域
                const sqlConversionCard = document.getElementById('sqlConversionCard');
                if (sqlConversionCard) {
                    sqlConversionCard.style.display = 'none';
                }
            }
            
            // 隱藏分頁資訊
            paginationInfo.textContent = '';
            
            // 更新表格標題
            dataTableHead.innerHTML = '';
            const headerRow = document.createElement('tr');
            result.columns.forEach(column => {
                const th = document.createElement('th');
                th.textContent = column;
                headerRow.appendChild(th);
            });
            dataTableHead.appendChild(headerRow);
            
            // 更新表格數據
            dataTableBody.innerHTML = '';
            result.data.forEach(row => {
                const tr = document.createElement('tr');
                result.columns.forEach(column => {
                    const td = document.createElement('td');
                    td.textContent = row[column] !== null ? row[column] : '';
                    tr.appendChild(td);
                });
                dataTableBody.appendChild(tr);
            });
            
            // 隱藏分頁按鈕
            document.getElementById('prevBtn').disabled = true;
            document.getElementById('nextBtn').disabled = true;
            
            // 顯示數據卡片
            dataCard.style.display = 'block';
        }

        function formatNumber(num) {
            if (num === undefined || num === null || isNaN(num)) {
                return '0';
            }
            return new Intl.NumberFormat('zh-TW').format(Math.round(num));
        }

        // 複製到剪貼簿功能
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    // 顯示成功提示
                    const button = event.target.closest('button');
                    const originalText = button.innerHTML;
                    button.innerHTML = '<i class="fas fa-check"></i> 已複製';
                    button.classList.remove('btn-outline-info');
                    button.classList.add('btn-success');
                    
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.classList.remove('btn-success');
                        button.classList.add('btn-outline-info');
                    }, 2000);
                }).catch(err => {
                    console.error('複製失敗:', err);
                    alert('複製失敗，請手動複製');
                });
            } else {
                // 降級方案：使用傳統方法
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    alert('已複製到剪貼簿');
                } catch (err) {
                    alert('複製失敗，請手動複製');
                }
                document.body.removeChild(textArea);
            }
        }

        // 圖表類型選擇器
        let currentChartType = 'bar';
        
        function createChartTypeSelector() {
            const chartContainer = document.getElementById('chartContainer');
            if (!chartContainer.querySelector('.chart-type-selector')) {
                const selectorHTML = `
                    <div class="chart-type-selector mb-3">
                        <div class="btn-group" role="group" aria-label="圖表類型選擇">
                            <input type="radio" class="btn-check" name="chartType" id="chartTypeBar" value="bar" checked>
                            <label class="btn btn-outline-primary" for="chartTypeBar">
                                <i class="fas fa-chart-bar"></i> 長條圖
                            </label>
                            
                            <input type="radio" class="btn-check" name="chartType" id="chartTypePie" value="pie">
                            <label class="btn btn-outline-primary" for="chartTypePie">
                                <i class="fas fa-chart-pie"></i> 圓餅圖
                            </label>
                            
                            <input type="radio" class="btn-check" name="chartType" id="chartTypeDoughnut" value="doughnut">
                            <label class="btn btn-outline-primary" for="chartTypeDoughnut">
                                <i class="fas fa-circle"></i> 環形圖
                            </label>
                            
                            <input type="radio" class="btn-check" name="chartType" id="chartTypeLine" value="line">
                            <label class="btn btn-outline-primary" for="chartTypeLine">
                                <i class="fas fa-chart-line"></i> 折線圖
                            </label>
                            
                            <input type="radio" class="btn-check" name="chartType" id="chartTypeRadar" value="radar">
                            <label class="btn btn-outline-primary" for="chartTypeRadar">
                                <i class="fas fa-star"></i> 雷達圖
                            </label>
                        </div>
                    </div>
                `;
                chartContainer.insertAdjacentHTML('afterbegin', selectorHTML);
                
                // 添加事件監聽器
                document.querySelectorAll('input[name="chartType"]').forEach(radio => {
                    radio.addEventListener('change', function() {
                        currentChartType = this.value;
                        if (window.lastDriverData && window.lastDimensionText) {
                            updateChart(window.lastDriverData, window.lastDimensionText);
                        }
                    });
                });
            }
        }

        function updateChart(driverData, dimensionText) {
            // 安全檢查：確保 driverData 是有效的數組
            if (!driverData || !Array.isArray(driverData) || driverData.length === 0) {
                console.warn('圖表數據無效或為空:', driverData);
                // 清空圖表區域
                const chartContainer = document.getElementById('chartContainer');
                if (chartContainer) {
                    chartContainer.innerHTML = '<div class="text-center text-muted p-4">暫無圖表數據</div>';
                }
                return;
            }
            
            const ctx = document.getElementById('chartCanvas').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }

            // 保存數據供圖表類型切換使用
            window.lastDriverData = driverData;
            window.lastDimensionText = dimensionText;

            const labels = driverData.map(item => item['分析維度'] || 'N/A');
            const data = driverData.map(item => item['差異'] || 0);
            
            // 為不同圖表類型準備不同的顏色方案
            const positiveColor = 'rgba(40, 167, 69, 0.8)';
            const negativeColor = 'rgba(220, 53, 69, 0.8)';
            const neutralColor = 'rgba(108, 117, 125, 0.8)';
            
            const colors = data.map(value => {
                const numValue = parseFloat(value) || 0;
                if (numValue > 0) return positiveColor;
                if (numValue < 0) return negativeColor;
                return neutralColor;
            });

            // 為圓餅圖和環形圖準備更豐富的顏色
            const pieColors = [
                'rgba(255, 99, 132, 0.8)',
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 206, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(153, 102, 255, 0.8)',
                'rgba(255, 159, 64, 0.8)',
                'rgba(199, 199, 199, 0.8)',
                'rgba(83, 102, 255, 0.8)',
                'rgba(78, 252, 3, 0.8)',
                'rgba(252, 3, 244, 0.8)'
            ];

            let chartConfig = {
                type: currentChartType,
                data: {
                    labels: labels,
                    datasets: [{
                        label: currentChartType === 'pie' || currentChartType === 'doughnut' ? '差異金額' : '',
                        data: data,
                        backgroundColor: currentChartType === 'pie' || currentChartType === 'doughnut' ? pieColors.slice(0, labels.length) : colors,
                        borderColor: currentChartType === 'pie' || currentChartType === 'doughnut' ? 
                            (pieColors.slice(0, labels.length) || []).map(color => color.replace('0.8', '1')) : 
                            (colors || []).map(color => color.replace('0.8', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `差異原因數據圖表（依${dimensionText}）`
                        },
                        legend: {
                            display: currentChartType === 'pie' || currentChartType === 'doughnut' || currentChartType === 'radar',
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y || context.parsed;
                                    const formattedValue = new Intl.NumberFormat('zh-TW').format(Math.abs(value));
                                    const sign = value >= 0 ? '+' : '-';
                                    return `${context.label}: ${sign}${formattedValue}`;
                                }
                            }
                        }
                    }
                }
            };

            // 為不同圖表類型添加特定配置
            if (currentChartType === 'bar') {
                chartConfig.options.scales = {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '差異金額'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: dimensionText
                        }
                    }
                };
            } else if (currentChartType === 'line') {
                chartConfig.options.scales = {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '差異金額'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: dimensionText
                        }
                    }
                };
                chartConfig.data.datasets[0].borderColor = (colors || []).map(color => color.replace('0.8', '1'));
                chartConfig.data.datasets[0].fill = false;
                chartConfig.data.datasets[0].tension = 0.1;
            } else if (currentChartType === 'radar') {
                chartConfig.options.scales = {
                    r: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '差異金額'
                        }
                    }
                };
                chartConfig.data.datasets[0].fill = true;
                chartConfig.data.datasets[0].backgroundColor = (colors || []).map(color => color.replace('0.8', '0.2'));
            }

            chart = new Chart(ctx, chartConfig);
        }

        // 聊天功能
        let chatHistory = [];
        let currentAnalysisContext = null;

        // 初始化聊天功能
        document.addEventListener('DOMContentLoaded', function() {
            const chatInput = document.getElementById('chatInput');
            const sendChatBtn = document.getElementById('sendChatBtn');

            // 發送按鈕點擊事件
            sendChatBtn.addEventListener('click', sendChatMessage);
            
            // 輸入框回車事件
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendChatMessage();
                }
            });

            // 模態視窗顯示時重新初始化聊天
            const aiChatModal = document.getElementById('aiChatModal');
            if (aiChatModal) {
                aiChatModal.addEventListener('shown.bs.modal', function() {
                    // 重新獲取聊天元素
                    const chatInput = document.getElementById('chatInput');
                    const sendChatBtn = document.getElementById('sendChatBtn');
                    
                    // 重新綁定事件
                    sendChatBtn.addEventListener('click', sendChatMessage);
                    chatInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            sendChatMessage();
                        }
                    });

                    // 重置聊天視窗
                    resetChatWindow();
                });
            }
        });

        // 發送聊天訊息
        async function sendChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            
            if (!message) {
                return;
            }

            // 添加用戶訊息到聊天視窗
            addChatMessage('user', message);
            chatInput.value = '';

            // 顯示打字動畫
            showTypingIndicator();

            try {
                // 準備聊天上下文
                const chatContext = {
                    message: message,
                    analysis_context: currentAnalysisContext,
                    chat_history: chatHistory.slice(-5) // 只發送最近5條訊息
                };

                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(chatContext)
                });

                const result = await response.json();

                if (response.ok) {
                    // 隱藏打字動畫
                    hideTypingIndicator();
                    
                    // 添加AI回覆
                    addChatMessage('ai', result.response);
                } else {
                    hideTypingIndicator();
                    addChatMessage('ai', '抱歉，我現在無法回應您的問題。請稍後再試。');
                }
            } catch (error) {
                hideTypingIndicator();
                addChatMessage('ai', '抱歉，發生錯誤。請檢查網路連線後再試。');
            }
        }

        // 添加聊天訊息到視窗
        function addChatMessage(sender, message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            
            const avatar = document.createElement('div');
            avatar.className = `message-avatar ${sender}`;
            avatar.innerHTML = sender === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';
            
            const bubble = document.createElement('div');
            bubble.className = `message-bubble ${sender}`;
            bubble.textContent = message;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(bubble);
            chatMessages.appendChild(messageDiv);
            
            // 滾動到底部
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // 保存到歷史記錄
            chatHistory.push({ sender, message });
        }

        // 顯示打字動畫
        function showTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-typing';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="message-avatar ai">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-bubble ai">
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // 隱藏打字動畫
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // 重置聊天視窗
        function resetChatWindow() {
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                chatMessages.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-comments"></i> 開始與 AI 討論分析建議...
                    </div>
                `;
            }
        }

        // 專業報告生成功能
        let currentReport = null;

        // 初始化報告生成功能
        document.addEventListener('DOMContentLoaded', function() {
            const generateReportBtn = document.getElementById('generateReportBtn');
            const downloadReportBtn = document.getElementById('downloadReportBtn');

            // 生成報告按鈕點擊事件
            generateReportBtn.addEventListener('click', generateProfessionalReport);
            
            // 下載報告按鈕點擊事件
            downloadReportBtn.addEventListener('click', downloadReport);

            // 模態視窗顯示時重新初始化報告功能
            const reportModal = document.getElementById('reportModal');
            if (reportModal) {
                reportModal.addEventListener('shown.bs.modal', function() {
                    // 重新獲取報告元素
                    const generateReportBtn = document.getElementById('generateReportBtn');
                    const downloadReportBtn = document.getElementById('downloadReportBtn');
                    
                    // 重新綁定事件
                    generateReportBtn.addEventListener('click', generateProfessionalReport);
                    downloadReportBtn.addEventListener('click', downloadReport);
                });
            }
        });

        // 生成專業報告
        async function generateProfessionalReport() {
            const reportType = document.getElementById('reportType').value;
            const generateReportBtn = document.getElementById('generateReportBtn');
            const reportContent = document.getElementById('reportContent');
            const reportInfo = document.getElementById('reportInfo');
            const reportText = document.getElementById('reportText');

            // 檢查是否有分析結果
            if (!currentAnalysisContext) {
                alert('請先進行分析查詢，然後再生成專業報告。');
                return;
            }

            // 顯示載入狀態
            generateReportBtn.disabled = true;
            generateReportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 生成中...';
            reportContent.style.display = 'block';
            reportInfo.innerHTML = '正在生成專業報告，請稍候...';
            reportText.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i><br>報告生成中...</div>';

            try {
                const response = await fetch('/generate-report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        analysis_context: currentAnalysisContext,
                        report_type: reportType,
                        chat_context: chatHistory
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // 保存當前報告
                    currentReport = result;
                    
                    // 更新報告資訊
                    const reportTypeNames = {
                        'general': '綜合經營分析報告',
                        'performance': '銷售績效分析報告',
                        'strategy': '經營策略規劃報告',
                        'risk': '風險評估管理報告'
                    };
                    
                    reportInfo.innerHTML = `
                        <div class="report-info">
                            <strong>報告類型：</strong>${reportTypeNames[reportType]}<br>
                            <strong>生成時間：</strong>${result.generated_at}<br>
                            <strong>使用模型：</strong>${result.model}<br>
                            <strong>對談記錄：</strong>${result.chat_context_used || 0} 條對話
                        </div>
                    `;
                    
                    // 顯示報告內容
                    reportText.innerHTML = `<div class="report-content">${formatReportContent(result.report)}</div>`;
                    
                    // 顯示下載按鈕
                    document.getElementById('downloadReportBtn').style.display = 'inline-block';
                    
                    // 顯示成功訊息
                    showAlert('專業報告生成成功！', 'success');
                } else {
                    reportInfo.innerHTML = '報告生成失敗';
                    reportText.innerHTML = `<div class="alert alert-danger">錯誤：${result.error}</div>`;
                    showAlert('報告生成失敗：' + result.error, 'danger');
                }
            } catch (error) {
                reportInfo.innerHTML = '報告生成失敗';
                reportText.innerHTML = `<div class="alert alert-danger">網路錯誤：${error.message}</div>`;
                showAlert('報告生成失敗：網路錯誤', 'danger');
            } finally {
                // 恢復按鈕狀態
                generateReportBtn.disabled = false;
                generateReportBtn.innerHTML = '<i class="fas fa-file-alt"></i> 生成專業報告';
            }
        }

        // 格式化報告內容
        function formatReportContent(reportText) {
            // 將 Markdown 格式轉換為 HTML
            let formattedText = reportText
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^#### (.*$)/gim, '<h4>$1</h4>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');
            
            // 包裝在段落標籤中
            formattedText = '<p>' + formattedText + '</p>';
            
            // 清理多餘的段落標籤
            formattedText = formattedText.replace(/<\/p><p><\/p><p>/g, '</p><p>');
            formattedText = formattedText.replace(/<p><\/p>/g, '');
            
            return formattedText;
        }

        // 下載報告
        function downloadReport() {
            if (!currentReport) {
                alert('沒有可下載的報告。');
                return;
            }

            // 創建報告文件名
            const reportTypeNames = {
                'general': '綜合經營分析報告',
                'performance': '銷售績效分析報告',
                'strategy': '經營策略規劃報告',
                'risk': '風險評估管理報告'
            };
            
            const fileName = `${reportTypeNames[currentReport.report_type]}_${currentReport.generated_at.replace(/[^0-9]/g, '')}.txt`;
            
            // 創建下載連結
            const blob = new Blob([currentReport.report], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showAlert('報告下載成功！', 'success');
        }

        // 顯示提示訊息
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // 插入到頁面頂部
            const container = document.querySelector('.main-container');
            container.insertBefore(alertDiv, container.firstChild);
            
            // 3秒後自動消失
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        }

        // 業績預測功能
        let currentForecast = null;

        // 初始化預測功能
        document.addEventListener('DOMContentLoaded', function() {
            const generateForecastBtn = document.getElementById('generateForecastBtn');
            const downloadForecastBtn = document.getElementById('downloadForecastBtn');
            const forecastTypeSelect = document.getElementById('forecastType');
            const forecastPeriodsInput = document.getElementById('forecastPeriods');
            const forecastMethod = document.getElementById('forecastMethod');
            const forecastDimension = document.getElementById('forecastDimension');
            let forecastDimensionValue = null;
            if (forecastDimension.value === 'product' || forecastDimension.value === 'customer') {
                forecastDimensionValue = document.getElementById('forecastDimensionValue').value;
            }

            // 生成預測按鈕點擊事件
            if (generateForecastBtn) {
                generateForecastBtn.addEventListener('click', generateForecast);
            }
            
            // 下載預測按鈕點擊事件
            if (downloadForecastBtn) {
                downloadForecastBtn.addEventListener('click', downloadForecast);
            }

            // 預測類型變更時自動調整建議期數
            if (forecastTypeSelect) {
                forecastTypeSelect.addEventListener('change', function() {
                    const forecastType = this.value;
                    
                    switch(forecastType) {
                        case 'month':
                            forecastPeriodsInput.value = 12;
                            break;
                        case 'quarter':
                            forecastPeriodsInput.value = 4;
                            break;
                        case 'year':
                            forecastPeriodsInput.value = 3;
                            break;
                    }
                });
            }

            // 模態視窗顯示時重新初始化預測功能
            const forecastModal = document.getElementById('forecastModal');
            if (forecastModal) {
                forecastModal.addEventListener('shown.bs.modal', function() {
                    // 重新獲取預測元素
                    const generateForecastBtn = document.getElementById('generateForecastBtn');
                    const downloadForecastBtn = document.getElementById('downloadForecastBtn');
                    
                    // 重新綁定事件
                    if (generateForecastBtn) {
                        generateForecastBtn.addEventListener('click', generateForecast);
                    }
                    if (downloadForecastBtn) {
                        downloadForecastBtn.addEventListener('click', downloadForecast);
                    }
                });
            }
        });

        // 生成業績預測
        async function generateForecast() {
            const forecastType = document.getElementById('forecastType').value;
            const forecastPeriods = parseInt(document.getElementById('forecastPeriods').value);
            const forecastMethod = document.getElementById('forecastMethod').value;
            const forecastDimension = document.getElementById('forecastDimension').value;
            let forecastDimensionValue = null;
            if (forecastDimension === 'product' || forecastDimension === 'customer') {
                forecastDimensionValue = document.getElementById('forecastDimensionValue').value;
            }
            const generateForecastBtn = document.getElementById('generateForecastBtn');
            const forecastContent = document.getElementById('forecastContent');
            const forecastInfo = document.getElementById('forecastInfo');
            const forecastText = document.getElementById('forecastText');

            // 驗證輸入
            if (forecastPeriods < 1 || forecastPeriods > 60) {
                alert('預測期數必須在 1-60 之間');
                return;
            }
            if ((forecastDimension === 'product' || forecastDimension === 'customer') && !forecastDimensionValue) {
                alert('請選擇細項');
                return;
            }
            // 顯示載入狀態
            generateForecastBtn.disabled = true;
            generateForecastBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 預測中...';
            forecastContent.style.display = 'block';
            forecastInfo.innerHTML = '正在生成業績預測，請稍候...';
            forecastText.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i><br>預測生成中...</div>';

            try {
                const response = await fetch('/generate-forecast', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        forecast_type: forecastType,
                        periods: forecastPeriods,
                        method: forecastMethod,
                        dimension: forecastDimension,
                        value: forecastDimensionValue
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // 保存當前預測
                    currentForecast = result;
                    
                    // 更新預測資訊
                    forecastInfo.innerHTML = `
                        <div class="report-info">
                            <strong>預測類型：</strong>${result.period_text}<br>
                            <strong>預測期數：</strong>${result.periods}<br>
                            <strong>總預測銷售額：</strong>${result.total_forecast.toLocaleString()} 元<br>
                            <strong>平均${result.period_text.slice(0, 1)}度銷售額：</strong>${result.avg_forecast.toLocaleString()} 元
                        </div>
                    `;
                    
                    // 生成預測圖表
                    setTimeout(() => {
                        try {
                            generateForecastChart(result);
                        } catch (error) {
                            console.error('生成預測圖表時發生錯誤:', error);
                            // 顯示錯誤信息
                            const chartContainer = document.querySelector('#forecastChart').parentElement;
                            if (chartContainer) {
                                chartContainer.innerHTML = `
                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        圖表生成失敗: ${error.message}
                                    </div>
                                `;
                            }
                        }
                    }, 100);
                    
                    // 格式化預測內容
                    let formattedContent = formatForecastContent(result);
                    forecastText.innerHTML = formattedContent;
                    
                    // 顯示下載按鈕
                    document.getElementById('downloadForecastBtn').style.display = 'inline-block';
                    document.getElementById('downloadChartBtn').style.display = 'inline-block';
                    
                    // 顯示成功訊息
                    showAlert('業績預測生成成功！', 'success');
                } else {
                    forecastInfo.innerHTML = '預測生成失敗';
                    forecastText.innerHTML = `<div class="alert alert-danger">錯誤：${result.error}</div>`;
                    showAlert('預測生成失敗：' + result.error, 'danger');
                }
            } catch (error) {
                forecastInfo.innerHTML = '預測生成失敗';
                forecastText.innerHTML = `<div class="alert alert-danger">網路錯誤：${error.message}</div>`;
                showAlert('預測生成失敗：網路錯誤', 'danger');
            } finally {
                // 恢復按鈕狀態
                generateForecastBtn.disabled = false;
                generateForecastBtn.innerHTML = '<i class="fas fa-chart-line"></i> 生成預測';
            }
        }

        // 生成預測圖表
        function generateForecastChart(result) {
            try {
                console.log('開始生成預測圖表...');
                console.log('Chart.js 狀態:', typeof Chart);
                
                // 檢查Chart.js是否可用
                if (typeof Chart === 'undefined') {
                    console.error('Chart.js 未載入');
                    return;
                }
                
                const canvas = document.getElementById('forecastChart');
                if (!canvas) {
                    console.error('找不到預測圖表canvas元素');
                    return;
                }
                
                console.log('Canvas 元素找到:', canvas);
                
                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    console.error('無法獲取canvas上下文');
                    return;
                }
                
                console.log('Canvas 上下文獲取成功');
                
                // 銷毀現有圖表
                if (window.forecastChart && typeof window.forecastChart.destroy === 'function') {
                    console.log('銷毀現有圖表');
                    window.forecastChart.destroy();
                }
                
                console.log('準備數據...');
                
                            // 準備歷史數據
            const historicalLabels = [];
            const historicalData = [];
            if (result.historical_data && result.historical_data.length > 0) {
                result.historical_data.forEach(item => {
                    historicalLabels.push(item.period);
                    historicalData.push(item.sales);
                });
            }
            
            // 準備預測數據
            const forecastLabels = [];
            const forecastData = [];
            if (result.forecast_data && result.forecast_data.length > 0) {
                result.forecast_data.forEach(item => {
                    forecastLabels.push(item.period);
                    forecastData.push(item.forecast_sales);
                });
            }
            
            // 合併標籤並確保連續性
            const allLabels = [...historicalLabels, ...forecastLabels];
            
            console.log('歷史數據:', historicalData);
            console.log('預測數據:', forecastData);
            console.log('所有標籤:', allLabels);
            
            // 創建數據集
            const datasets = [];
            
            // 添加歷史數據集（黑色）
            if (historicalData.length > 0) {
                datasets.push({
                    label: '歷史數據',
                    data: [...historicalData, ...Array(forecastData.length).fill(null)],
                    borderColor: '#000000',
                    backgroundColor: 'rgba(0, 0, 0, 0.1)',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.1,
                    spanGaps: false, // 不跨越空值
                    pointRadius: 3, // 顯示數據點
                    pointHoverRadius: 5
                });
            }
            
            // 添加預測數據集（綠色）
            if (forecastData.length > 0) {
                datasets.push({
                    label: '預測數據',
                    data: [...Array(historicalData.length).fill(null), ...forecastData],
                    borderColor: '#28a745', // 改為綠色
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    borderWidth: 2, // 與歷史數據相同的線條寬度
                    fill: false,
                    tension: 0.1,
                    borderDash: [8, 4], // 調整虛線樣式
                    spanGaps: false, // 不跨越空值
                    pointRadius: 3, // 與歷史數據相同的點大小
                    pointHoverRadius: 5
                });
            }
            
            // 添加連續線數據集（確保歷史和預測之間連續）
            if (historicalData.length > 0 && forecastData.length > 0) {
                // 創建一個包含所有數據的連續線
                const continuousData = [...historicalData, ...forecastData];
                
                datasets.push({
                    label: '',  // 移除標籤
                    data: continuousData,
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    borderWidth: 1,
                    fill: false,
                    tension: 0.1,
                    borderDash: [2, 2],
                    spanGaps: true, // 跨越空值以連接線條
                    pointRadius: 0, // 不顯示點
                    pointHoverRadius: 0,
                    showLine: true, // 顯示線條
                    hidden: false  // 顯示線條
                });
            }
            

            
            // 創建圖表
            window.forecastChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: allLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${result.period_text}銷售預測趨勢圖`
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '銷售額 (元)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '期間'
                            }
                        }
                    }
                }
            });
            
            console.log('預測圖表生成成功');
        } catch (error) {
            console.error('生成預測圖表時發生錯誤:', error);
            // 在圖表區域顯示錯誤信息
            const chartContainer = document.querySelector('#forecastChart').parentElement;
            if (chartContainer) {
                chartContainer.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        圖表生成失敗: ${error.message}
                    </div>
                `;
            }
        }
        }

        // 格式化預測內容
        function formatForecastContent(result) {
            let content = '<div class="report-content">';
            // 添加預測摘要
            content += result.forecast_summary.replace(/\n/g, '<br>');
            // 添加預測數據表格
            if (result.forecast_data && result.forecast_data.length > 0) {
                content += '<br><h5>預測數據詳情</h5>';
                content += '<div class="table-responsive"><table class="table table-striped">';
                content += '<thead><tr><th>期間</th><th>預測銷售額</th></tr></thead><tbody>';
                result.forecast_data.forEach(item => {
                    content += `<tr><td>${item.period}</td><td>${item.forecast_sales.toLocaleString()} 元</td></tr>`;
                });
                content += '</tbody></table></div>';
            }
            // 添加模型信息
            if (result.model_info) {
                if (result.model_info.method === 'ARIMA' && result.model_info.order) {
                    content += `<br><div class="alert alert-info"><strong>模型信息：</strong>ARIMA(${result.model_info.order[0]},${result.model_info.order[1]},${result.model_info.order[2]}) | AIC: ${result.model_info.aic}</div>`;
                } else if (result.model_info.method === 'ETS') {
                    content += `<br><div class="alert alert-info"><strong>模型信息：</strong>ETS | trend: ${result.model_info.trend || '-'} | seasonal: ${result.model_info.seasonal || '-'} | seasonal_periods: ${result.model_info.seasonal_periods || '-'} | AIC: ${result.model_info.aic}</div>`;
                }
            }
            content += '</div>';
            return content;
        }

        // 下載預測
        function downloadForecast() {
            if (!currentForecast) {
                alert('沒有可下載的預測。');
                return;
            }

            // 創建預測文件名
            const forecastTypeNames = {
                'month': '月度預測',
                'quarter': '季度預測',
                'year': '年度預測'
            };
            
            const fileName = `${forecastTypeNames[currentForecast.forecast_type]}_${new Date().toISOString().slice(0, 10)}.txt`;
            
            // 創建下載連結
            const blob = new Blob([currentForecast.forecast_summary], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showAlert('預測下載成功！', 'success');
        }

        // 下載圖表
        function downloadChart() {
            try {
                if (!window.forecastChart) {
                    alert('沒有可下載的圖表。');
                    return;
                }

                // 創建圖表文件名
                const forecastTypeNames = {
                    'month': '月度預測',
                    'quarter': '季度預測',
                    'year': '年度預測'
                };
                
                const fileName = `${forecastTypeNames[currentForecast.forecast_type]}_趨勢圖_${new Date().toISOString().slice(0, 10)}.png`;
                
                // 獲取圖表數據URL
                const canvas = document.getElementById('forecastChart');
                if (!canvas) {
                    alert('找不到圖表元素。');
                    return;
                }
                
                const url = canvas.toDataURL('image/png');
                
                // 創建下載連結
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showAlert('圖表下載成功！', 'success');
            } catch (error) {
                console.error('下載圖表時發生錯誤:', error);
                alert('下載圖表失敗: ' + error.message);
            }
        }

        function onForecastDimensionChange() {
            const dim = document.getElementById('forecastDimension').value;
            const valueCol = document.getElementById('forecastDimensionValueCol');
            const valueSelect = document.getElementById('forecastDimensionValue');
            const valueLabel = document.getElementById('forecastDimensionValueLabel');
            if (dim === 'product' || dim === 'customer') {
                valueCol.style.display = '';
                valueLabel.textContent = (dim === 'product') ? '產品名稱：' : '客戶名稱：';
                valueSelect.innerHTML = '<option>載入中...</option>';
                fetch(`/api/dimension-list?dimension=${dim}`)
                    .then(res => res.json())
                    .then(list => {
                        valueSelect.innerHTML = '';
                        if (list && Array.isArray(list)) {
                            list.forEach(item => {
                                const opt = document.createElement('option');
                                opt.value = item.id || '';
                                opt.textContent = item.name || 'N/A';
                                valueSelect.appendChild(opt);
                            });
                        } else {
                            console.warn('維度列表為空或格式錯誤');
                        }
                    });
            } else {
                valueCol.style.display = 'none';
                valueSelect.innerHTML = '';
            }
        }

        // 生成預設摘要報告
        function generateDefaultSummary(data) {
            try {
                let summary = '<div class="analysis-summary">';
                
                // 基本時間範圍信息
                if (data.period_text) {
                    summary += `<div class="summary-section"><strong>分析期間：</strong>${data.period_text}</div>`;
                }
                
                // 銷售數據摘要
                if (data.current_sales !== undefined && data.last_sales !== undefined) {
                    const currentSales = parseFloat(data.current_sales) || 0;
                    const lastSales = parseFloat(data.last_sales) || 0;
                    const diff = parseFloat(data.diff) || 0;
                    const percentageDiff = parseFloat(data.percentage_diff) || 0;
                    
                    summary += `<div class="summary-section"><strong>銷售表現：</strong>`;
                    summary += `當期銷售額：${formatNumber(currentSales)} 元，`;
                    summary += `前期銷售額：${formatNumber(lastSales)} 元，`;
                    summary += `差異：${diff >= 0 ? '+' : ''}${formatNumber(diff)} 元`;
                    
                    if (percentageDiff !== 0 && percentageDiff !== Infinity && percentageDiff !== -Infinity) {
                        summary += ` (${diff >= 0 ? '+' : ''}${percentageDiff.toFixed(2)}%)`;
                    }
                    summary += '</div>';
                }
                
                // 維度分析摘要
                if (data.dimension_text) {
                    summary += `<div class="summary-section"><strong>分析維度：</strong>${data.dimension_text}</div>`;
                }
                
                // 貢獻度分析摘要
                if (data.driver_data && Array.isArray(data.driver_data) && data.driver_data.length > 0) {
                    summary += `<div class="summary-section"><strong>主要貢獻因素：</strong>`;
                    const topDrivers = data.driver_data
                        .filter(row => row && row['分析維度'])
                        .sort((a, b) => Math.abs(parseFloat(b['差異'] || 0)) - Math.abs(parseFloat(a['差異'] || 0)))
                        .slice(0, 3);
                    
                    if (topDrivers.length > 0) {
                        topDrivers.forEach((driver, index) => {
                            const diff = parseFloat(driver['差異']) || 0;
                            const sign = diff >= 0 ? '+' : '';
                            summary += `${driver['分析維度']}（${sign}${formatNumber(diff)} 元）`;
                            if (index < topDrivers.length - 1) summary += '、';
                        });
                    }
                    summary += '</div>';
                }
                
                // 其他維度參考
                if (data.other_dimension_reference && data.other_dimension_reference.trim() !== '') {
                    summary += `<div class="summary-section"><strong>其他維度影響：</strong>${data.other_dimension_reference}</div>`;
                }
                
                // 分析建議
                summary += `<div class="summary-section"><strong>分析建議：</strong>`;
                if (data.diff > 0) {
                    summary += '銷售表現優於前期，建議分析成功因素並持續優化。';
                } else if (data.diff < 0) {
                    summary += '銷售表現低於前期，建議深入分析下滑原因並制定改進策略。';
                } else {
                    summary += '銷售表現與前期持平，建議尋找新的增長機會。';
                }
                summary += '</div>';
                
                summary += '</div>';
                return summary;
                
            } catch (error) {
                console.error('生成預設摘要報告失敗:', error);
                return '<div class="text-muted">摘要報告生成中...</div>';
            }
        }
        
        // 讓 AI 助手視窗可拖曳
        document.addEventListener('DOMContentLoaded', function() {
            const aiChatModal = document.getElementById('aiChatModal');
            if (aiChatModal) {
                let isDragging = false;
                let offsetX = 0;
                let offsetY = 0;
                let dialog = aiChatModal.querySelector('.modal-dialog');
                let header = aiChatModal.querySelector('.modal-header');
                if (dialog && header) {
                    header.style.cursor = 'move';
                    header.addEventListener('mousedown', function(e) {
                        isDragging = true;
                        // 取得滑鼠與 dialog 左上角的距離
                        const rect = dialog.getBoundingClientRect();
                        offsetX = e.clientX - rect.left;
                        offsetY = e.clientY - rect.top;
                        // 讓 dialog 定位為 fixed
                        dialog.style.position = 'fixed';
                        dialog.style.margin = '0';
                        dialog.style.left = rect.left + 'px';
                        dialog.style.top = rect.top + 'px';
                    });
                    document.addEventListener('mousemove', function(e) {
                        if (isDragging) {
                            dialog.style.left = (e.clientX - offsetX) + 'px';
                            dialog.style.top = (e.clientY - offsetY) + 'px';
                        }
                    });
                    document.addEventListener('mouseup', function() {
                        isDragging = false;
                    });
                    // 每次 modal 關閉時重置位置
                    aiChatModal.addEventListener('hidden.bs.modal', function() {
                        dialog.style.position = '';
                        dialog.style.left = '';
                        dialog.style.top = '';
                        dialog.style.margin = '';
                    });
                }
            }
        });

        // 語音播放相關函數
        let currentVoiceData = null;
        let currentAudio = null;

        function showVoiceControlSection() {
            // 顯示語音播放控制區域
            const voiceControlSection = document.getElementById('voiceControlSection');
            if (voiceControlSection) {
                voiceControlSection.style.display = 'block';
            }
            
            // 檢查語音功能狀態
            checkVoiceStatus();
        }

        function checkVoiceStatus() {
            // 檢查語音功能狀態
            fetch('/api/voice/status')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const voiceStatus = document.getElementById('voiceStatus');
                        const voiceStatusText = document.getElementById('voiceStatusText');
                        
                        if (data.voice_synthesis_available) {
                            voiceStatusText.innerHTML = '語音合成功能可用';
                            voiceStatus.style.display = 'block';
                        } else {
                            voiceStatusText.innerHTML = '語音合成功能不可用，請安裝相關套件';
                            voiceStatus.style.display = 'block';
                        }
                    }
                })
                .catch(error => {
                    console.error('檢查語音狀態失敗:', error);
                });
        }

        function generateVoiceSummary() {
            // 生成語音總結
            const summaryElement = document.getElementById('summary');
            const summaryText = summaryElement.innerHTML;
            
            if (!summaryText || summaryText.trim() === '') {
                alert('請先生成分析總結報告');
                return;
            }

            // 顯示載入狀態
            const generateVoiceBtn = document.getElementById('generateVoiceBtn');
            const originalText = generateVoiceBtn.innerHTML;
            generateVoiceBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 生成中...';
            generateVoiceBtn.disabled = true;

            // 發送請求生成語音
            fetch('/api/voice/summary', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    summary_text: summaryText,
                    voice_type: 'mandarin_female'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 保存語音數據
                    currentVoiceData = data;
                    
                    // 顯示語音內容
                    const voiceContent = document.getElementById('voiceContent');
                    const voiceContentText = document.getElementById('voiceContentText');
                    voiceContentText.innerHTML = data.voice_content;
                    voiceContent.style.display = 'block';
                    
                    // 啟用播放按鈕
                    const playVoiceBtn = document.getElementById('playVoiceBtn');
                    playVoiceBtn.disabled = false;
                    
                    // 顯示成功訊息
                    showAlert('success', '語音總結生成成功！點擊播放按鈕收聽。');
                    
                } else {
                    showAlert('danger', `語音總結生成失敗: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('生成語音總結失敗:', error);
                showAlert('danger', '生成語音總結失敗，請稍後再試');
            })
            .finally(() => {
                // 恢復按鈕狀態
                generateVoiceBtn.innerHTML = originalText;
                generateVoiceBtn.disabled = false;
            });
        }

            function playVoiceSummary() {
        // 播放語音總結
        if (!currentVoiceData || !currentVoiceData.audio_file_path) {
            alert('請先生成語音總結');
            return;
        }

        try {
            // 停止當前播放的音頻
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }

            // 從音頻文件路徑中提取文件名
            const audioFileName = currentVoiceData.audio_file_path.split('/').pop();
            
            // 構建音頻URL
            const audioUrl = `/api/voice/audio/${audioFileName}`;
            
            console.log('播放音頻URL:', audioUrl);
            console.log('音頻文件名:', audioFileName);
            
            // 創建音頻元素
            currentAudio = new Audio();
            
            // 設置音頻事件
            currentAudio.onloadstart = function() {
                console.log('音頻開始載入');
                const playVoiceBtn = document.getElementById('playVoiceBtn');
                playVoiceBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 載入中...';
                playVoiceBtn.disabled = true;
            };
            
            currentAudio.oncanplay = function() {
                console.log('音頻可以播放');
                const playVoiceBtn = document.getElementById('playVoiceBtn');
                playVoiceBtn.innerHTML = '<i class="fas fa-pause"></i> ⏸️ 暫停';
                playVoiceBtn.disabled = false;
                playVoiceBtn.onclick = pauseVoiceSummary;
            };
            
            currentAudio.onended = function() {
                console.log('音頻播放結束');
                const playVoiceBtn = document.getElementById('playVoiceBtn');
                playVoiceBtn.innerHTML = '<i class="fas fa-play"></i> ▶️ 播放語音';
                playVoiceBtn.disabled = false;
                playVoiceBtn.onclick = playVoiceSummary;
                currentAudio = null;
            };
            
            currentAudio.onerror = function(e) {
                console.error('音頻播放錯誤:', e);
                console.error('音頻錯誤詳情:', currentAudio.error);
                showAlert('danger', '音頻播放失敗，請稍後再試');
                const playVoiceBtn = document.getElementById('playVoiceBtn');
                playVoiceBtn.innerHTML = '<i class="fas fa-play"></i> ▶️ 播放語音';
                playVoiceBtn.disabled = false;
                playVoiceBtn.onclick = playVoiceSummary;
            };
            
            // 設置音頻屬性
            currentAudio.volume = 1.0;  // 設置音量為最大
            currentAudio.preload = 'auto';  // 預載入音頻
            currentAudio.playbackRate = getCurrentPlaybackSpeed();  // 使用當前選擇的播放速度
            
            // 設置音頻源
            currentAudio.src = audioUrl;
            
            // 添加載入事件
            currentAudio.onloadeddata = function() {
                console.log('音頻數據載入完成，時長:', currentAudio.duration);
            };
            
            // 添加播放事件
            currentAudio.onplay = function() {
                console.log('音頻開始播放');
            };
            
            // 添加暫停事件
            currentAudio.onpause = function() {
                console.log('音頻暫停');
            };
            
            // 添加進度事件
            currentAudio.ontimeupdate = function() {
                console.log('音頻播放進度:', currentAudio.currentTime, '/', currentAudio.duration);
            };
            
            // 開始播放
            const playPromise = currentAudio.play();
            
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    console.log('音頻播放成功啟動');
                }).catch(error => {
                    console.error('音頻播放失敗:', error);
                    showAlert('danger', `音頻播放失敗: ${error.message}`);
                });
            }
            
        } catch (error) {
            console.error('播放語音失敗:', error);
            showAlert('danger', '播放語音失敗，請稍後再試');
        }
    }

        function pauseVoiceSummary() {
            // 暫停語音播放
            if (currentAudio) {
                currentAudio.pause();
                
                const playVoiceBtn = document.getElementById('playVoiceBtn');
                playVoiceBtn.innerHTML = '<i class="fas fa-play"></i> ▶️ 播放語音';
                playVoiceBtn.disabled = false;
                playVoiceBtn.onclick = playVoiceSummary;
            }
        }

        function changePlaybackSpeed() {
            // 改變播放速度
            const speedSelect = document.getElementById('playbackSpeed');
            const selectedSpeed = parseFloat(speedSelect.value);
            
            if (currentAudio) {
                currentAudio.playbackRate = selectedSpeed;
                console.log(`播放速度已調整為: ${selectedSpeed}x`);
                
                // 顯示速度調整提示
                showAlert('info', `播放速度已調整為 ${selectedSpeed}x`);
            }
        }

        function getCurrentPlaybackSpeed() {
            // 獲取當前選擇的播放速度
            const speedSelect = document.getElementById('playbackSpeed');
            return parseFloat(speedSelect.value);
        }

        function showAlert(type, message) {
            // 顯示提示訊息
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // 插入到頁面頂部
            const container = document.querySelector('.main-container');
            container.insertBefore(alertDiv, container.firstChild);
            
            // 自動隱藏
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html> 