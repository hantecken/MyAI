<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµ±ä¸€é æ¸¬åœ–è¡¨ - NL2Cube æ™ºæ…§åˆ†æç³»çµ±</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        .chart-container {
            position: relative;
            height: 500px;
            width: 100%;
        }
        
        .forecast-card {
            transition: transform 0.2s;
        }
        
        .forecast-card:hover {
            transform: translateY(-2px);
        }
        
        .status-badge {
            font-size: 0.8rem;
        }
        
        .loading-spinner {
            display: none;
        }
        
        .result-section {
            min-height: 200px;
        }
        
        .chart-placeholder {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 400px;
            color: #6c757d;
        }
        
        .ai-analysis-report {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid #28a745;
        }
        
        .ai-analysis-report h1, .ai-analysis-report h2, .ai-analysis-report h3 {
            color: #2c3e50;
            font-weight: 600;
            margin-top: 25px;
            margin-bottom: 15px;
        }
        
        .ai-analysis-report h1 {
            font-size: 24px;
            border-bottom: 2px solid #28a745;
            padding-bottom: 10px;
        }
        
        .ai-analysis-report h2 {
            font-size: 20px;
            color: #34495e;
        }
        
        .ai-analysis-report h3 {
            font-size: 18px;
            color: #7f8c8d;
        }
        
        .ai-analysis-report p {
            margin-bottom: 15px;
            text-align: justify;
        }
        
        .ai-analysis-report strong {
            color: #e74c3c;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- å°èˆªæ¬„ -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-chart-line me-2"></i>
                çµ±ä¸€é æ¸¬åœ–è¡¨
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/"><i class="fas fa-home me-1"></i>é¦–é </a>
                <a class="nav-link" href="/unified-forecast-simple"><i class="fas fa-flask me-1"></i>ç°¡åŒ–æ¸¬è©¦</a>
                <a class="nav-link" href="/debug-unified-forecast"><i class="fas fa-bug me-1"></i>å•é¡Œè¨ºæ–·</a>
                <a class="nav-link" href="#" onclick="testCrewAI()"><i class="fas fa-robot me-1"></i>æ™ºæ…§åˆ†æ</a>
                <a class="nav-link" href="/crewai/test-page"><i class="fas fa-vial me-1"></i>æ™ºæ…§åˆ†ææ¸¬è©¦</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- é é¢æ¨™é¡Œ -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <h1 class="mb-2">
                            <i class="fas fa-chart-line me-3"></i>
                            çµ±ä¸€é æ¸¬åœ–è¡¨ç³»çµ±
                        </h1>
                        <p class="mb-0 fs-5">çµåˆæ¥­ç¸¾é æ¸¬ç´°è†©åœ–è¡¨ + AI æ·±åº¦åˆ†æçš„æ™ºæ…§é æ¸¬å¹³å°</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- é æ¸¬æ§åˆ¶é¢æ¿ -->
        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="card shadow-sm">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="fas fa-cogs me-2"></i>
                            é æ¸¬åƒæ•¸è¨­å®š
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">é æ¸¬é¡å‹</label>
                                <select id="forecastType" class="form-select">
                                    <option value="month">æœˆåº¦é æ¸¬</option>
                                    <option value="quarter">å­£åº¦é æ¸¬</option>
                                    <option value="year">å¹´åº¦é æ¸¬</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">é æ¸¬æœŸæ•¸</label>
                                <input type="number" id="periods" class="form-control" value="12" min="1" max="24">
                                <div class="form-text">è«‹è¼¸å…¥1-24ä¹‹é–“çš„æ•¸å­—</div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">AI åˆ†æ</label>
                                <div class="form-check form-switch mt-2">
                                    <input class="form-check-input" type="checkbox" id="enableAiAnalysis" checked>
                                    <label class="form-check-label" for="enableAiAnalysis">å•Ÿç”¨ AI æ·±åº¦åˆ†æ</label>
                                </div>
                            </div>
                        </div>
                        <div class="text-center">
                            <button onclick="generateUnifiedForecast()" id="generateBtn" class="btn btn-warning btn-lg">
                                <span id="btnText">
                                    <i class="fas fa-chart-line me-2"></i>
                                    ç”Ÿæˆçµ±ä¸€é æ¸¬
                                </span>
                                <span id="btnSpinner" class="spinner-border spinner-border-sm loading-spinner" role="status" aria-hidden="true"></span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            ç³»çµ±ç‰¹è‰²
                        </h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled mb-0">
                            <li class="mb-2">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                <strong>ç´°è†©åœ–è¡¨ï¼š</strong>ä½¿ç”¨ matplotlib ç”Ÿæˆé«˜å“è³ªéœæ…‹åœ–è¡¨
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                <strong>AI åˆ†æï¼š</strong>æ•´åˆ Gemini API é€²è¡Œæ·±åº¦æ¥­å‹™åˆ†æ
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                <strong>çµ±ä¸€ä»‹é¢ï¼š</strong>å–®ä¸€ API æä¾›å®Œæ•´é æ¸¬åŠŸèƒ½
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                <strong>æ•¸æ“šä¸€è‡´æ€§ï¼š</strong>çµ±ä¸€çš„æ¨¡å‹åƒæ•¸ç¢ºä¿é æ¸¬çµæœä¸€è‡´
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- é æ¸¬çµæœå€åŸŸ -->
        <div id="result" class="result-section"></div>
        
        <!-- åœ–è¡¨é¡¯ç¤ºå€åŸŸ -->
        <div id="chart" class="result-section">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-area me-2"></i>
                        çµ±ä¸€é æ¸¬åœ–è¡¨
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-placeholder">
                        <div class="text-center">
                            <i class="fas fa-chart-line fa-3x mb-3 text-muted"></i>
                            <h5 class="text-muted">è«‹é»æ“Šä¸Šæ–¹æŒ‰éˆ•ç”Ÿæˆé æ¸¬åœ–è¡¨</h5>
                            <p class="text-muted">ç³»çµ±å°‡é¡¯ç¤ºæ­·å²æ•¸æ“šã€é æ¸¬è¶¨å‹¢å’Œ AI åˆ†æçµæœ</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- AI åˆ†æçµæœå€åŸŸ -->
        <div id="analysis" class="result-section"></div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // ç”Ÿæˆçµ±ä¸€é æ¸¬çš„ä¸»è¦å‡½æ•¸
        async function generateUnifiedForecast() {
            const btn = document.getElementById('generateBtn');
            const btnText = document.getElementById('btnText');
            const btnSpinner = document.getElementById('btnSpinner');
            const resultDiv = document.getElementById('result');
            const chartDiv = document.getElementById('chart');
            const analysisDiv = document.getElementById('analysis');
            
            const type = document.getElementById('forecastType').value;
            const periods = parseInt(document.getElementById('periods').value);
            const enableAiAnalysis = document.getElementById('enableAiAnalysis').checked;
            
            // é©—è­‰è¼¸å…¥
            if (periods < 1 || periods > 24) {
                resultDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>é æ¸¬æœŸæ•¸å¿…é ˆåœ¨1åˆ°24ä¹‹é–“</div>';
                return;
            }
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            btn.disabled = true;
            btnText.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ç”Ÿæˆä¸­...';
            btnSpinner.classList.remove('loading-spinner');
            resultDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>æ­£åœ¨ç”Ÿæˆçµ±ä¸€é æ¸¬çµæœï¼Œè«‹ç¨å€™...</div>';
            chartDiv.innerHTML = '';
            analysisDiv.innerHTML = '';
            
            try {
                const response = await fetch('/api/unified-forecast', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: type,
                        periods: periods,
                        enable_ai_analysis: enableAiAnalysis
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    // é¡¯ç¤ºé æ¸¬æ•¸æ“š
                    displayForecastResults(data);
                    
                    // é¡¯ç¤ºåœ–è¡¨
                    displayForecastChart(data);
                    
                    // é¡¯ç¤º AI åˆ†æ
                    displayAIAnalysis(data);
                    
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger">
                        <h4 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>çµ±ä¸€é æ¸¬å¤±æ•—</h4>
                        <p>${data.error}</p>
                    </div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">
                    <h4 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>ç³»çµ±éŒ¯èª¤</h4>
                    <p>ç„¡æ³•é€£æ¥åˆ°ä¼ºæœå™¨æˆ–è™•ç†éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ã€‚</p>
                    <hr>
                    <p class="mb-0">è©³ç´°éŒ¯èª¤ï¼š${error.message}</p>
                </div>`;
            } finally {
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                btn.disabled = false;
                btnText.innerHTML = '<i class="fas fa-chart-line me-2"></i>ç”Ÿæˆçµ±ä¸€é æ¸¬';
                btnSpinner.classList.add('loading-spinner');
            }
        }
        
        // é¡¯ç¤ºé æ¸¬çµæœ
        function displayForecastResults(data) {
            const resultDiv = document.getElementById('result');
            
            let html = '<div class="row">';
            
            // å·¦å´ï¼šé æ¸¬æ•¸æ“š
            html += '<div class="col-lg-6">';
            html += '<div class="card mb-3 forecast-card">';
            html += '<div class="card-header bg-success text-white">';
            html += '<h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>é æ¸¬çµæœ</h5>';
            html += '</div><div class="card-body">';
            html += `<p><strong>ç¸½é æ¸¬éŠ·å”®é¡ï¼š</strong>NT$ ${data.total_forecast.toLocaleString()}</p>`;
            html += `<p><strong>å¹³å‡æœˆéŠ·å”®é¡ï¼š</strong>NT$ ${data.avg_forecast.toLocaleString()}</p>`;
            html += `<p><strong>é æ¸¬æœŸæ•¸ï¼š</strong>${data.periods} ${data.forecast_type}</p>`;
            html += `<p><strong>é æ¸¬ç¯„åœï¼š</strong>${data.forecast_range}</p>`;
            html += '</div></div>';
            
            html += '<div class="card forecast-card">';
            html += '<div class="card-header bg-info text-white">';
            html += '<h5 class="mb-0"><i class="fas fa-table me-2"></i>è©³ç´°é æ¸¬æ•¸æ“š</h5>';
            html += '</div><div class="card-body">';
            html += '<div class="table-responsive">';
            html += '<table class="table table-striped table-hover">';
            html += '<thead class="table-light"><tr><th>æœŸé–“</th><th class="text-end">é æ¸¬éŠ·å”®é¡</th></tr></thead>';
            html += '<tbody>';
            data.forecast_data.forEach(item => {
                html += `<tr><td>${item.period}</td><td class="text-end">NT$ ${item.forecast_sales.toLocaleString()}</td></tr>`;
            });
            html += '</tbody></table></div></div></div>';
            html += '</div>';
            
            // å³å´ï¼šæ¨¡å‹è³‡è¨Š
            html += '<div class="col-lg-6">';
            html += '<div class="card mb-3 forecast-card">';
            html += '<div class="card-header bg-warning text-white">';
            html += '<h5 class="mb-0"><i class="fas fa-cogs me-2"></i>æ¨¡å‹è³‡è¨Š</h5>';
            html += '</div><div class="card-body">';
            html += `<p><strong>æ¨¡å‹é¡å‹ï¼š</strong>${data.model_info.model_type}</p>`;
            html += `<p><strong>è¨“ç·´æœŸé–“ï¼š</strong>${data.model_info.training_period.start} - ${data.model_info.training_period.end}</p>`;
            html += `<p><strong>åƒæ•¸ï¼š</strong>ARIMA(${data.model_info.parameters.order.join(',')}) Ã— SARIMA(${data.model_info.parameters.seasonal_order.join(',')})</p>`;
            html += `<p><strong>AICï¼š</strong>${data.model_info.model_summary.aic.toFixed(2)}</p>`;
            html += `<p><strong>BICï¼š</strong>${data.model_info.model_summary.bic.toFixed(2)}</p>`;
            html += '</div></div>';
            
            // æ­·å²æ•¸æ“šçµ±è¨ˆ
            if (data.historical_data && data.historical_data.stats) {
                const stats = data.historical_data.stats;
                html += '<div class="card forecast-card">';
                html += '<div class="card-header bg-secondary text-white">';
                html += '<h5 class="mb-0"><i class="fas fa-history me-2"></i>æ­·å²æ•¸æ“šçµ±è¨ˆ</h5>';
                html += '</div><div class="card-body">';
                html += `<p><strong>æ•¸æ“šé»æ•¸ï¼š</strong>${stats.data_points} å€‹æœˆ</p>`;
                html += `<p><strong>ç¸½æ­·å²éŠ·å”®ï¼š</strong>NT$ ${stats.total_sales.toLocaleString()}</p>`;
                html += `<p><strong>å¹³å‡æœˆéŠ·å”®ï¼š</strong>NT$ ${stats.avg_monthly_sales.toLocaleString()}</p>`;
                html += `<p><strong>éŠ·å”®æ¨™æº–å·®ï¼š</strong>NT$ ${stats.sales_std.toLocaleString()}</p>`;
                html += '</div></div>';
            }
            html += '</div>';
            
            html += '</div>';
            resultDiv.innerHTML = html;
        }
        
        // é¡¯ç¤ºé æ¸¬åœ–è¡¨
        function displayForecastChart(data) {
            const chartDiv = document.getElementById('chart');
            
            chartDiv.innerHTML = `
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-area me-2"></i>
                            çµ±ä¸€é æ¸¬åœ–è¡¨
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="forecastChart"></canvas>
                        </div>
                    </div>
                </div>
            `;
            
            // ç”Ÿæˆå°ˆæ¥­é æ¸¬åœ–è¡¨
            setTimeout(() => {
                generateUnifiedForecastChart(data);
            }, 100);
        }
        
        // é¡¯ç¤º AI åˆ†æ
        function displayAIAnalysis(data) {
            const analysisDiv = document.getElementById('analysis');
            
            if (data.ai_analysis && data.ai_analysis.success) {
                analysisDiv.innerHTML = `
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-robot me-2"></i>
                                AI æ·±åº¦åˆ†æå ±å‘Š
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="ai-analysis-report" style="white-space: pre-wrap; font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; font-size: 16px; line-height: 1.8; color: #2c3e50;">
                                ${data.ai_analysis.analysis}
                            </div>
                        </div>
                    </div>
                `;
            } else if (data.ai_analysis) {
                analysisDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        AI åˆ†ææœªåŸ·è¡Œï¼š${data.ai_analysis.message || data.ai_analysis.error}
                    </div>
                `;
            }
        }
        
        // ç”Ÿæˆçµ±ä¸€é æ¸¬åœ–è¡¨çš„å‡½æ•¸
        function generateUnifiedForecastChart(data) {
            try {
                console.log('é–‹å§‹ç”Ÿæˆçµ±ä¸€é æ¸¬åœ–è¡¨...');
                
                // æª¢æŸ¥Chart.jsæ˜¯å¦å¯ç”¨
                if (typeof Chart === 'undefined') {
                    console.error('Chart.js æœªè¼‰å…¥');
                    return;
                }
                
                const canvas = document.getElementById('forecastChart');
                if (!canvas) {
                    console.error('æ‰¾ä¸åˆ°é æ¸¬åœ–è¡¨canvaså…ƒç´ ');
                    return;
                }
                
                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    console.error('ç„¡æ³•ç²å–canvasä¸Šä¸‹æ–‡');
                    return;
                }
                
                // éŠ·æ¯€ç¾æœ‰åœ–è¡¨
                if (window.forecastChart && typeof window.forecastChart.destroy === 'function') {
                    window.forecastChart.destroy();
                }
                
                // æº–å‚™æ­·å²æ•¸æ“š - ç¢ºä¿è‡³å°‘é¡¯ç¤º2å¹´æ­·å²è³‡æ–™
                const historicalLabels = [];
                const historicalData = [];
                if (data.historical_data && data.historical_data.dates && data.historical_data.data) {
                    // ä½¿ç”¨å¾Œç«¯è¿”å›çš„æ­·å²æ•¸æ“šæ ¼å¼
                    const dates = data.historical_data.dates;
                    const sales = data.historical_data.data;
                    
                    // ç¢ºä¿æ•¸æ“šå°æ‡‰
                    for (let i = 0; i < Math.min(dates.length, sales.length); i++) {
                        historicalLabels.push(dates[i]);
                        historicalData.push(sales[i]);
                    }
                    
                    console.log(`ğŸ“Š è¼‰å…¥æ­·å²è³‡æ–™ï¼š${historicalData.length} ç­†ï¼ŒæœŸé–“ï¼š${historicalLabels[0]} è‡³ ${historicalLabels[historicalLabels.length - 1]}`);
                }
                
                // æº–å‚™é æ¸¬æ•¸æ“š
                const forecastLabels = [];
                const forecastData = [];
                if (data.forecast_data && data.forecast_data.length > 0) {
                    data.forecast_data.forEach(item => {
                        forecastLabels.push(item.period);
                        forecastData.push(item.forecast_sales);
                    });
                }
                
                // åˆä½µæ¨™ç±¤
                const allLabels = [...historicalLabels, ...forecastLabels];
                
                // å‰µå»ºå°ˆæ¥­çš„æ•¸æ“šé›†
                const datasets = [];
                
                // æ­·å²æ•¸æ“šé›† - ä½¿ç”¨æ·±è—è‰²ç·šæ¢ï¼ŒåŒ…å«åˆ°å‰æœˆçš„æ­·å²è³‡æ–™
                if (historicalData.length > 0) {
                    datasets.push({
                        label: 'ğŸ“Š æ­·å²æ¥­ç¸¾ (è‡³å‰æœˆ)',
                        data: historicalData,
                        borderColor: '#1e3a8a', // æ·±è—è‰²
                        backgroundColor: 'rgba(30, 58, 138, 0.1)',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.2,
                        pointRadius: 6,
                        pointHoverRadius: 10,
                        pointBackgroundColor: '#ffffff',
                        pointBorderColor: '#1e3a8a',
                        pointBorderWidth: 2,
                        pointStyle: 'circle'
                    });
                }
                
                // é æ¸¬æ•¸æ“šé›† - éœ€è¦æ¥çºŒåœ¨æ­·å²æ•¸æ“šä¹‹å¾Œ
                if (forecastData.length > 0) {
                    // å‰µå»ºå®Œæ•´çš„æ•¸æ“šé™£åˆ—ï¼ŒåŒ…å«æ­·å²æ•¸æ“šçš„ null å€¼å’Œé æ¸¬æ•¸æ“š
                    const fullForecastData = [];
                    
                    // åœ¨æ­·å²æ•¸æ“šä½ç½®å¡«å…¥ nullï¼Œè®“é æ¸¬ç·šå¾æ­·å²æ•¸æ“šçµå°¾é–‹å§‹
                    for (let i = 0; i < historicalData.length; i++) {
                        fullForecastData.push(null);
                    }
                    
                    // æ·»åŠ é æ¸¬æ•¸æ“š
                    fullForecastData.push(...forecastData);
                    
                    datasets.push({
                        label: 'ğŸ”® é æ¸¬è¶¨å‹¢',
                        data: fullForecastData,
                        borderColor: '#2ca02c',
                        backgroundColor: 'rgba(44, 160, 44, 0.15)',
                        borderWidth: 4,
                        fill: false,
                        tension: 0.3,
                        pointRadius: 8,
                        pointHoverRadius: 12,
                        pointBackgroundColor: '#ffffff',
                        pointBorderColor: '#2ca02c',
                        pointBorderWidth: 3,
                        borderDash: [10, 5],
                        spanGaps: true  // å…è¨±è·¨è¶Š null å€¼
                    });
                }
                
                // å‰µå»ºå°ˆæ¥­åœ–è¡¨
                window.forecastChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: allLabels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: `ğŸ“ˆ ${data.forecast_type || 'æ¥­ç¸¾'} é æ¸¬è¶¨å‹¢åˆ†æ (å«æ­·å²è³‡æ–™)`,
                                font: {
                                    size: 18,
                                    weight: 'bold'
                                },
                                color: '#2c3e50',
                                padding: 20
                            },
                            subtitle: {
                                display: true,
                                text: 'æ·±è—è‰²ç·šæ¢ï¼šæ­·å²æ¥­ç¸¾æ•¸æ“š (è‡³å‰æœˆ) | ç¶ è‰²è™›ç·šï¼šAIé æ¸¬è¶¨å‹¢ (ç•¶æœˆèµ·)',
                                font: {
                                    size: 14
                                },
                                color: '#7f8c8d',
                                padding: 10
                            },
                            legend: {
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    padding: 20,
                                    font: {
                                        size: 12
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'æ™‚é–“æœŸé–“',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                },
                                grid: {
                                    color: '#E0E0E0',
                                    lineWidth: 1
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'éŠ·å”®é¡ (NT$)',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                },
                                grid: {
                                    color: '#E0E0E0',
                                    lineWidth: 1
                                },
                                ticks: {
                                    callback: function(value) {
                                        return 'NT$ ' + value.toLocaleString();
                                    }
                                }
                            }
                        },
                        elements: {
                            point: {
                                hoverBackgroundColor: '#ffffff',
                                hoverBorderWidth: 3
                            }
                        }
                    }
                });
                
                console.log('çµ±ä¸€é æ¸¬åœ–è¡¨ç”Ÿæˆå®Œæˆ');
                
            } catch (error) {
                console.error('ç”Ÿæˆåœ–è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                const chartDiv = document.getElementById('chart');
                chartDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        åœ–è¡¨ç”Ÿæˆå¤±æ•—ï¼š${error.message}
                    </div>
                `;
            }
        }
        
        // è¼¸å…¥é©—è­‰
        document.getElementById('periods').addEventListener('input', function(e) {
            const value = parseInt(e.target.value);
            if (value < 1) e.target.value = 1;
            if (value > 24) e.target.value = 24;
        });
        
        // é é¢è¼‰å…¥å®Œæˆå¾Œçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('çµ±ä¸€é æ¸¬åœ–è¡¨é é¢è¼‰å…¥å®Œæˆ');
            
            // æª¢æŸ¥é—œéµçµ„ä»¶
            console.log('Chart.js ç‹€æ…‹:', typeof Chart !== 'undefined' ? 'å·²è¼‰å…¥' : 'æœªè¼‰å…¥');
            console.log('Bootstrap ç‹€æ…‹:', typeof bootstrap !== 'undefined' ? 'å·²è¼‰å…¥' : 'æœªè¼‰å…¥');
            
            // æª¢æŸ¥ DOM å…ƒç´ 
            const elements = ['forecastType', 'periods', 'enableAiAnalysis', 'generateBtn'];
            elements.forEach(id => {
                const element = document.getElementById(id);
                console.log(`å…ƒç´  ${id}:`, element ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
            });
            
            // é¡¯ç¤ºé é¢ç‹€æ…‹
            showPageStatus();
        });
        
        // é¡¯ç¤ºé é¢ç‹€æ…‹
        function showPageStatus() {
            const statusDiv = document.createElement('div');
            statusDiv.className = 'alert alert-info alert-dismissible fade show';
            statusDiv.innerHTML = `
                <i class="fas fa-info-circle me-2"></i>
                <strong>é é¢ç‹€æ…‹æª¢æŸ¥ï¼š</strong>
                <ul class="mb-0 mt-2">
                    <li>Chart.js: ${typeof Chart !== 'undefined' ? 'âœ… å·²è¼‰å…¥' : 'âŒ æœªè¼‰å…¥'}</li>
                    <li>Bootstrap: ${typeof bootstrap !== 'undefined' ? 'âœ… å·²è¼‰å…¥' : 'âŒ æœªè¼‰å…¥'}</li>
                    <li>DOM å…ƒç´ : ${checkDOMElements()}</li>
                    <li>æ™ºæ…§åˆ†æ: <a href="#" onclick="testCrewAI(); return false;" class="text-decoration-none">é»æ“Šæ¸¬è©¦</a></li>
                </ul>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // æ’å…¥åˆ°é é¢é ‚éƒ¨
            const container = document.querySelector('.container');
            container.insertBefore(statusDiv, container.firstChild);
        }
        
        // æª¢æŸ¥ DOM å…ƒç´ 
        function checkDOMElements() {
            const elements = ['forecastType', 'periods', 'enableAiAnalysis', 'generateBtn'];
            const existing = elements.filter(id => document.getElementById(id)).length;
            return `${existing}/${elements.length} å…ƒç´ å­˜åœ¨`;
        }
        
        // æ™ºæ…§åˆ†ææ¸¬è©¦åŠŸèƒ½
        async function testCrewAI() {
            try {
                console.log('ğŸ¤– é–‹å§‹æ¸¬è©¦ CrewAI æ™ºæ…§åˆ†æåŠŸèƒ½...');
                
                // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
                const statusDiv = document.createElement('div');
                statusDiv.id = 'crewai-status';
                statusDiv.className = 'alert alert-info';
                statusDiv.innerHTML = `
                    <i class="fas fa-robot me-2"></i>
                    <strong>æ­£åœ¨æ¸¬è©¦ CrewAI æ™ºæ…§åˆ†æåŠŸèƒ½...</strong>
                    <div class="spinner-border spinner-border-sm ms-2" role="status"></div>
                `;
                
                // æ’å…¥åˆ°é é¢é ‚éƒ¨
                const container = document.querySelector('.container');
                container.insertBefore(statusDiv, container.firstChild);
                
                // æ¸¬è©¦ CrewAI ç‹€æ…‹
                const statusResponse = await fetch('/crewai/status');
                const statusData = await statusResponse.json();
                
                if (statusData.available) {
                    // åŸ·è¡Œæ™ºæ…§é æ¸¬
                    const forecastResponse = await fetch('/crewai/forecast', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ periods: 12 })
                    });
                    
                    const forecastData = await forecastResponse.json();
                    
                    if (forecastData.success) {
                        statusDiv.className = 'alert alert-success';
                        statusDiv.innerHTML = `
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>CrewAI æ™ºæ…§åˆ†ææ¸¬è©¦æˆåŠŸï¼</strong>
                            <br><small>é æ¸¬æœŸæ•¸ï¼š${forecastData.periods}ï¼Œæ™‚é–“æˆ³è¨˜ï¼š${forecastData.timestamp}</small>
                            <button type="button" class="btn-close ms-2" onclick="this.parentElement.remove()"></button>
                        `;
                        
                        console.log('âœ… CrewAI æ™ºæ…§åˆ†ææ¸¬è©¦æˆåŠŸ:', forecastData);
                    } else {
                        throw new Error(forecastData.error);
                    }
                } else {
                    throw new Error('CrewAI åŠŸèƒ½æœªå•Ÿç”¨');
                }
                
            } catch (error) {
                console.error('âŒ CrewAI æ™ºæ…§åˆ†ææ¸¬è©¦å¤±æ•—:', error);
                
                const statusDiv = document.getElementById('crewai-status');
                if (statusDiv) {
                    statusDiv.className = 'alert alert-warning';
                    statusDiv.innerHTML = `
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>CrewAI æ™ºæ…§åˆ†ææ¸¬è©¦å¤±æ•—</strong>
                        <br><small>éŒ¯èª¤ï¼š${error.message}</small>
                        <button type="button" class="btn-close ms-2" onclick="this.parentElement.remove()"></button>
                    `;
                }
            }
        }
    </script>
</body>
</html>
